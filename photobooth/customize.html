<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- SECURITY HARDENING -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: blob: https:; font-src 'self' data: https:;">
    <script src="security.js"></script>

    <title>Photo Time | Studio Editor</title>

    <style>
        /* GLOBAL SECURITY CSS */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
        }
    </style>

    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;700;800&family=Outfit:wght@300;500;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
        /* --- STUDIO VARIABLES --- */
        :root {
            --bg-light: #1565C0;
            /* Deep Blue Background */
            --text-dark: #FFFFFF;
            /* White Text */
            --glass: rgba(255, 255, 255, 0.15);
            /* Glass on Dark */
            --glass-strong: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.2);
            --primary: #fff;
            /* Primary buttons white on blue */
            --accent: #64B5F6;
            --radius-md: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- AURORA BACKGROUND (Shared) --- */
        .aurora-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0D47A1, #1565C0, #1976D2);
            /* Blue Gradient */
            overflow: hidden;
        }

        .aurora-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            /* Slightly less blur for definition */
            opacity: 0.4;
            animation: float 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }

        .blob-1 {
            top: -10%;
            left: -10%;
            width: 50vw;
            height: 50vw;
            background: #42A5F5;
            /* Lighter Blue */
        }

        .blob-2 {
            bottom: -20%;
            right: -10%;
            width: 60vw;
            height: 60vw;
            background: #039BE5;
            /* Deep Sky Blue */
            animation-delay: -5s;
        }

        .blob-3 {
            top: 40%;
            left: 40%;
            width: 40vw;
            height: 40vw;
            background: #64B5F6;
            /* Accent Blue */
            animation-delay: -10s;
        }

        @keyframes float {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(40px, 60px) scale(1.1);
            }
        }

        /* --- UI LAYOUT --- */
        #studio-layout {
            display: grid;
            grid-template-columns: 80px 1fr 340px;
            grid-template-rows: 60px 1fr;
            height: 100%;
            width: 100%;
        }

        /* --- HEADER --- */
        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            background: rgba(0, 0, 0, 0.3);
            /* Dark glass for white icons */
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
        }

        .brand {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: -0.5px;
            color: var(--text-dark);
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .btn-ghost {
            background: #1565C0;
            /* Default Deep Blue */
            color: #fff;
            border: 1px solid #1565C0;
        }

        .btn-ghost:hover {
            background: #fff;
            /* White on Hover */
            color: #1565C0;
            border-color: #1565C0;
        }

        .btn-icon-only {
            padding: 10px;
            width: 40px;
            height: 40px;
            justify-content: center;
        }

        .btn-primary {
            background: #1565C0;
            /* Default Deep Blue */
            color: #fff;
            border: 1px solid #1565C0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: #fff;
            /* White on Hover */
            color: #1565C0;
            border-color: #1565C0;
        }

        .btn:hover {
            opacity: 1;
            /* Disable opacity fade for solid color swap */
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #ccc !important;
            color: #666 !important;
            border-color: #ccc !important;
        }

        /* --- TOOLBAR --- */
        .toolbar {
            grid-column: 1;
            grid-row: 2;
            background: #fff;
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            gap: 16px;
            z-index: 90;
            overflow-y: auto;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid transparent;
            color: #999;
            cursor: pointer;
            transition: 0.2s;
        }

        .tool-btn i {
            width: 20px;
            height: 20px;
        }

        .tool-btn span {
            font-size: 0.6rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .tool-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .tool-btn.active {
            background: #1565C0;
            /* Deep Blue Active */
            color: #fff;
        }

        /* --- STAGE --- */
        .stage {
            grid-column: 2;
            grid-row: 2;
            background: transparent;
            /* Show Aurora */
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #canvas-wrapper {
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
            transform-origin: center center;
            display: inline-block;
            background: #fff;
            /* Paper backing */
        }

        /* --- PROPERTIES PANEL --- */
        .properties-panel {
            grid-column: 3;
            grid-row: 2;
            background: #fff;
            border-left: 1px solid var(--glass-border);
            padding: 0;
            overflow-y: auto;
            z-index: 90;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 16px;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .panel-content {
            padding: 0 24px 100px 24px;
        }

        .control-group {
            margin-bottom: 24px;
        }

        .control-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.5;
            margin-bottom: 10px;
        }

        /* --- TABS & GRIDS --- */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 6px 12px;
            background: #1565C0;
            /* Default Deep Blue */
            color: #fff;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #1565C0;
        }

        .tab:hover,
        .tab.active {
            background: #fff;
            /* White on Hover/Active */
            color: #1565C0;
            /* Blue Text */
            border-color: #1565C0;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .item-box {
            aspect-ratio: 1;
            background: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            border: 1px solid #eee;
            transition: all 0.1s;
        }

        .item-box:hover {
            background: #fafafa;
            border-color: #1565C0;
        }

        .filter-btn {
            padding: 12px;
            background: #1565C0;
            /* Default Deep Blue */
            color: #fff;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid #1565C0;
            cursor: pointer;
            transition: 0.2s;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #fff;
            /* White on Hover/Active */
            color: #1565C0;
            /* Blue Text */
            border-color: #1565C0;
        }

        /* Color & Brush Inputs */
        input[type="color"] {
            -webkit-appearance: none;
            border: 1px solid #eee;
            width: 100%;
            height: 40px;
            border-radius: 6px;
            padding: 0;
            overflow: hidden;
            cursor: pointer;
            background: #fff;
        }

        input[type="range"] {
            width: 100%;
            accent-color: #1565C0;
            /* Deep Blue Theme */
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
            background: #fff;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        /* --- RESPONSIVE REDESIGN (Complete Overhaul) --- */
        @media (max-width: 900px) {

            /* 1. Layout: Vertical Stack */
            #studio-layout {
                display: flex;
                flex-direction: column;
                height: 100vh;
                width: 100vw;
                overflow: hidden;
                position: relative;
            }

            /* 2. Header: Compact & Top */
            header {
                flex: 0 0 60px;
                padding: 0 16px;
                justify-content: space-between;
                background: rgba(21, 101, 192, 0.95);
                /* Deep Blue for visibility */
                z-index: 200;
            }

            .brand {
                display: none;
            }

            .hide-mobile {
                display: none;
            }

            /* Mobile doesn't need brand text saving space */
            .header-controls {
                width: 100%;
                justify-content: space-between;
                gap: 2px;
                /* Tighter gap */
            }

            .header-controls .btn {
                padding: 8px 8px;
                /* Tighter padding */
                font-size: 0.75rem;
                /* Slightly smaller text */
            }

            .btn-icon-only {
                width: 36px;
                height: 36px;
                padding: 0;
            }

            /* 3. Stage: Maximize Space */
            .stage {
                flex: 1;
                /* Takes all remaining space */
                width: 100%;
                background: transparent;
                display: flex;
                align-items: center;
                justify-content: center;
                padding-bottom: 80px;
                /* Space for toolbar */
                z-index: 50;
            }

            /* 4. Toolbar: Fixed Bottom Bar */
            .toolbar {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 70px;
                flex-direction: row;
                justify-content: space-evenly;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-right: none;
                border-top: 1px solid rgba(0, 0, 0, 0.05);
                padding: 0;
                gap: 0;
                z-index: 150;
            }

            .tool-btn {
                width: 100%;
                height: 100%;
                border-radius: 0;
                background: transparent;
            }

            .tool-btn.active {
                border-top: 3px solid #1565C0;
                /* Deep Blue Accent */
                background: rgba(21, 101, 192, 0.05);
                /* Blue Tint */
                color: #1565C0;
            }

            /* 5. Properties Panel: Slide-Up Bottom Sheet */
            .properties-panel {
                position: absolute;
                bottom: 70px;
                /* Above toolbar */
                left: 0;
                width: 100%;
                height: 40vh;
                /* Reduced from 50vh */
                max-height: 320px;
                /* Limit height */
                background: #fff;
                border-left: none;
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
                transform: translateY(110%);
                /* Hidden by default */
                transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                z-index: 100;
                display: flex;
                flex-direction: column;
            }

            .properties-panel.open {
                transform: translateY(0);
            }

            /* Shift stage when panel is open to keep canvas visible */
            body.panel-active .stage {
                padding-bottom: 0;
                transition: padding 0.3s;
            }

            /* Compact Styles for Panel Content */
            .grid-2 {
                gap: 8px;
            }

            .filter-btn {
                padding: 8px;
                font-size: 0.75rem;
            }

            .control-group {
                margin-bottom: 16px;
            }

            .btn-primary {
                padding: 8px 16px;
                font-size: 0.8rem;
            }

            input[type="range"] {
                height: 4px;
            }

            /* Smaller Font Preview */
            .filter-btn[style*="font-family"] {
                font-size: 1rem !important;
                padding: 10px;
            }

            /* Add a "Handle" to look like a sheet */
            .panel-header {
                padding: 12px;
                display: flex;
                justify-content: center;
                border-bottom: 1px solid #eee;
            }

            .panel-header::before {
                content: '';
                width: 40px;
                height: 4px;
                background: #ddd;
                border-radius: 2px;
                display: block;
            }

            .panel-header h2 {
                display: none;
            }

            /* Hide title, reliance on context */

            .panel-content {
                overflow-y: auto;
                padding: 20px;
                padding-bottom: 40px;
            }

            .panel-toggle {
                display: none;
            }

            /* Not needed */
        }
    </style>

    <style>body { visibility: hidden; opacity: 0; }</style> <!-- Hide until loaded -->
</head>
<body>
    <script>
        (function() {
            var e = "CiAgICA8ZGl2IGNsYXNzPSJhdXJvcmEtYmciPgogICAgICAgIDxkaXYgY2xhc3M9ImF1cm9yYS1ibG9iIGJsb2ItMSI+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iYXVyb3JhLWJsb2IgYmxvYi0yIj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJhdXJvcmEtYmxvYiBibG9iLTMiPjwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJzdHVkaW8tbGF5b3V0Ij4KICAgICAgICA8aGVhZGVyPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJicmFuZCI+U3R1ZGlvIEVkaXRvcjwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJoZWFkZXItY29udHJvbHMiPgogICAgICAgICAgICAgICAgPCEtLSBVbmRvIC8gUmVkbyAtLT4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QgYnRuLWljb24tb25seSIgb25jbGljaz0idW5kbygpIiBpZD0idW5kby1idG4iIHRpdGxlPSJVbmRvIj48aQogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLWx1Y2lkZT0idW5kby0yIj48L2k+PC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLWdob3N0IGJ0bi1pY29uLW9ubHkiIG9uY2xpY2s9InJlZG8oKSIgaWQ9InJlZG8tYnRuIiB0aXRsZT0iUmVkbyI+PGkKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS1sdWNpZGU9InJlZG8tMiI+PC9pPjwvYnV0dG9uPgoKICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJvcGFjaXR5OjAuMjsgY29sb3I6IGdyZXk7Ij58PC9zcGFuPgoKICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QiIG9uY2xpY2s9IndpbmRvdy5sb2NhdGlvbi5ocmVmPSdib290aC5odG1sJyI+PGkgZGF0YS1sdWNpZGU9ImFycm93LWxlZnQiCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlPSJ3aWR0aDoxNnB4Ij48L2k+IEJhY2s8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QiIG9uY2xpY2s9IndpbmRvdy5sb2NhdGlvbi5ocmVmPSdsYXlvdXQuaHRtbCciPjxpIGRhdGEtbHVjaWRlPSJsYXlvdXQtZ3JpZCIKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU9IndpZHRoOjE2cHgiPjwvaT4gPHNwYW4gY2xhc3M9ImhpZGUtbW9iaWxlIj5DaGFuZ2UgPC9zcGFuPkxheW91dDwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJwcmludFBob3RvKCkiPjxpIGRhdGEtbHVjaWRlPSJwcmludGVyIj48L2k+IFByaW50PC9idXR0b24+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvaGVhZGVyPgogICAgICAgIDxkaXYgY2xhc3M9InRvb2xiYXIiPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ0b29sLWJ0biBhY3RpdmUiIGRhdGEtaWQ9InN0aWNrZXJzIj48aQogICAgICAgICAgICAgICAgICAgIGRhdGEtbHVjaWRlPSJzdGlja2VyIj48L2k+PHNwYW4+U3RpY2tlcnM8L3NwYW4+PC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InRvb2wtYnRuIiBkYXRhLWlkPSJ0ZXh0Ij48aSBkYXRhLWx1Y2lkZT0idHlwZSI+PC9pPjxzcGFuPlRleHQ8L3NwYW4+PC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InRvb2wtYnRuIiBkYXRhLWlkPSJkcmF3Ij48aSBkYXRhLWx1Y2lkZT0icGVuY2lsIj48L2k+PHNwYW4+RHJhdzwvc3Bhbj48L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idG9vbC1idG4iIGRhdGEtaWQ9ImZpbHRlcnMiPjxpIGRhdGEtbHVjaWRlPSJzY2FuLWxpbmUiPjwvaT48c3Bhbj5FZGl0PC9zcGFuPjwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ0b29sLWJ0biIgZGF0YS1pZD0iYmFja2dyb3VuZCI+PGkgZGF0YS1sdWNpZGU9InBhbGV0dGUiPjwvaT48c3Bhbj5CRzwvc3Bhbj48L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idG9vbC1idG4iIGRhdGEtaWQ9Im1hZ2ljIj48aSBkYXRhLWx1Y2lkZT0id2FuZC0yIj48L2k+PHNwYW4+TWFnaWM8L3NwYW4+PC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ic3RhZ2UiIGlkPSJzdGFnZSI+CiAgICAgICAgICAgIDxkaXYgaWQ9ImNhbnZhcy13cmFwcGVyIj48Y2FudmFzIGlkPSJjIj48L2NhbnZhcz48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJwYW5lbC10b2dnbGUiIG9uY2xpY2s9ImRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYW5lbCcpLmNsYXNzTGlzdC50b2dnbGUoJ29wZW4nKSI+PGkKICAgICAgICAgICAgICAgIGRhdGEtbHVjaWRlPSJzbGlkZXJzLWhvcml6b250YWwiPjwvaT48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJwcm9wZXJ0aWVzLXBhbmVsIiBpZD0icGFuZWwiPjwvZGl2PgogICAgPC9kaXY+CiAgICA8c2NyaXB0IHR5cGU9Im1vZHVsZSI+CiAgICAgICAgaWYgKHdpbmRvdy5zZWxmID09PSB3aW5kb3cudG9wKSB7CiAgICAgICAgICAgIGFsZXJ0KCJUaGlzIGVkaXRvciBtdXN0IHJ1biBpbnNpZGUgdGhlIGJvb3RoLiIpOwogICAgICAgICAgICBsb2NhdGlvbi5ocmVmID0gImxheW91dC5odG1sIjsKICAgICAgICB9CgogICAgICAgIGltcG9ydCB7IGdldExheW91dENvbmZpZywgTEFZT1VUUyB9IGZyb20gJy4vbGF5b3V0Q29uZmlnLmpzJzsKCiAgICAgICAgY29uc3QgU1RJQ0tFUlMgPSB7CiAgICAgICAgICAgICJWaWJlcyI6IFsi4pyoIiwgIvCfkpYiLCAi8J+UpSIsICLwn5KAIiwgIvCfposiLCAi8J+RgCIsICLwn5KFIiwgIvCfko4iLCAi8J+RuyIsICLimqEiLCAi8J+NrSIsICLwn46oIiwgIvCfjJ8iLCAi8J+MmSIsICLwn461IiwgIuKYge+4jyJdLAogICAgICAgICAgICAiQ3liZXIiOiBbIvCfkb4iLCAi8J+kliIsICLwn5K/IiwgIvCflIsiLCAi8J+SuyIsICLwn5OhIiwgIvCflbnvuI8iLCAi8J+SvSIsICLwn5OfIiwgIvCflrHvuI8iLCAi4pqZ77iPIiwgIvCfp6wiLCAi8J+nqiIsICLwn5StIiwgIvCfjIwiLCAi8J+buCJdLAogICAgICAgICAgICAiRGVjb3IiOiBbIvCfjoAiLCAi8J+OiCIsICLwn46BIiwgIvCfjpAiLCAi8J+OiyIsICLwn46KIiwgIvCfqoUiLCAi8J+qtCIsICLwn42EIiwgIvCfjLoiLCAi8J+MuCIsICLwn5KuIiwgIvCfj7XvuI8iLCAi8J+miyIsICLwn5CIIiwgIvCfkJoiXSwKICAgICAgICAgICAgIkdyYWRpZW50IjogWyLwn5S0IiwgIvCfn6AiLCAi8J+foSIsICLwn5+iIiwgIvCflLUiLCAi8J+foyIsICLimqsiLCAi4pqqIiwgIvCfn6QiLCAi8J+fpSIsICLwn5+nIiwgIvCfn6giLCAi8J+fqSIsICLwn5+mIiwgIvCfn6oiLCAi4qybIl0sCiAgICAgICAgICAgICJMb3ZlIjogWyLinaTvuI8iLCAi8J+noSIsICLwn5KbIiwgIvCfkpoiLCAi8J+SmSIsICLwn5KcIiwgIvCflqQiLCAi8J+kjSIsICLwn5KMIiwgIvCfkosiLCAi8J+SjSIsICLwn5KQIiwgIvCfko8iLCAi8J+SkSIsICLinaPvuI8iLCAi8J+SlSJdLAogICAgICAgICAgICAiU3VtbWVyIjogWyLwn4y4IiwgIvCfjLwiLCAi8J+MuyIsICLimIDvuI8iLCAi8J+MmSIsICLirZAiLCAi4p2E77iPIiwgIvCfjIoiLCAi8J+MtCIsICLwn4y1IiwgIvCfjYQiLCAi8J+NgCIsICLwn5GZIiwgIvCflbbvuI8iLCAi8J+NpiIsICLwn425Il0sCiAgICAgICAgICAgICJGb29kIjogWyLwn42VIiwgIvCfjZQiLCAi8J+NnyIsICLwn4ytIiwgIvCfjb8iLCAi8J+lniIsICLwn6WQIiwgIvCfpagiLCAi8J+lryIsICLwn6WWIiwgIvCfp4AiLCAi8J+llyIsICLwn42jIiwgIvCfjbEiLCAi8J+lnyIsICLwn42kIl0sCiAgICAgICAgICAgICJXb3JkcyI6IFsiTE9MIiwgIk9NRyIsICJZT0xPIiwgIldPVyIsICJIRVkiLCAiQllFIiwgIlNVUCIsICJOT1BFIiwgIllFQUgiLCAiT0siLCAiU0xBWSIsICJMSVQiLCAiQkVUIiwgIlZJQkUiLCAiTU9PRCIsICJCUlVIIl0KICAgICAgICB9OwoKICAgICAgICBjb25zdCBQQVRURVJOUyA9IFsKICAgICAgICAgICAgeyBuYW1lOiAnRG90cycsIGRyYXc6IChjdHgsIHcsIGgpID0+IHsgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsMCwwLDAuMSknOyBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmModyAvIDIsIGggLyAyLCAyLCAwLCA2LjI4KTsgY3R4LmZpbGwoKTsgfSB9LAogICAgICAgICAgICB7IG5hbWU6ICdTdHJpcGVzJywgZHJhdzogKGN0eCwgdywgaCkgPT4geyBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgwLDAsMCwwLjEpJzsgY3R4LmxpbmVXaWR0aCA9IDI7IGN0eC5iZWdpblBhdGgoKTsgY3R4Lm1vdmVUbygwLCAwKTsgY3R4LmxpbmVUbyh3LCBoKTsgY3R4LnN0cm9rZSgpOyB9IH0sCiAgICAgICAgICAgIHsgbmFtZTogJ0dyaWQnLCBkcmF3OiAoY3R4LCB3LCBoKSA9PiB7IGN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsMCwwLDAuMSknOyBjdHguc3Ryb2tlUmVjdCgwLCAwLCB3LCBoKTsgfSB9LAogICAgICAgICAgICB7IG5hbWU6ICdDaGVjaycsIGRyYXc6IChjdHgsIHcsIGgpID0+IHsgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsMCwwLDAuMDUpJzsgY3R4LmZpbGxSZWN0KDAsIDAsIHcgLyAyLCBoIC8gMik7IGN0eC5maWxsUmVjdCh3IC8gMiwgaCAvIDIsIHcgLyAyLCBoIC8gMik7IH0gfQogICAgICAgIF07CgogICAgICAgIGxldCBjYW52YXMsIGFjdGl2ZU9iamVjdCwgY3VycmVudExheW91dElkID0gJycsIGN1cnJlbnRCZ0NvbG9yID0gJyNmZmZmZmYnLCBjdXJyZW50UGF0dGVybiA9IG51bGw7CgogICAgICAgIC8vIC0tLSBISVNUT1JZIFNUQVRFIC0tLQogICAgICAgIGxldCBoaXN0b3J5ID0gW107CiAgICAgICAgbGV0IGhpc3RvcnlQcm9jZXNzaW5nID0gZmFsc2U7CiAgICAgICAgbGV0IGhpc3RvcnlTdGVwID0gLTE7CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgYXN5bmMgKCkgPT4gewogICAgICAgICAgICBsdWNpZGUuY3JlYXRlSWNvbnMoKTsKICAgICAgICAgICAgaW5pdENhbnZhcygpOwogICAgICAgICAgICBhd2FpdCBsb2FkUHJvamVjdCgpOwogICAgICAgICAgICBzZXR1cFRvb2xiYXIoKTsKICAgICAgICAgICAgcmVuZGVyUGFuZWwoJ3N0aWNrZXJzJyk7CgogICAgICAgICAgICAvLyBHbG9iYWwgQ2xpY2sgT3V0c2lkZSBMaXN0ZW5lcgogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBwYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYW5lbCcpOwogICAgICAgICAgICAgICAgY29uc3QgaXNQYW5lbE9wZW4gPSBwYW5lbC5jbGFzc0xpc3QuY29udGFpbnMoJ29wZW4nKTsKCiAgICAgICAgICAgICAgICAvLyBJZiBjbGlja2VkIGluc2lkZSBwYW5lbCBvciBvbiBhIHRvb2xiYXIgYnV0dG9uLCBkbyBub3RoaW5nCiAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnLnByb3BlcnRpZXMtcGFuZWwnKSB8fCBlLnRhcmdldC5jbG9zZXN0KCcudG9vbC1idG4nKSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIC8vIElmIHBhbmVsIGlzIG9wZW4gYW5kIGNsaWNrIGlzIG91dHNpZGUsIGNsb3NlIGl0CiAgICAgICAgICAgICAgICBpZiAoaXNQYW5lbE9wZW4pIHsKICAgICAgICAgICAgICAgICAgICBwYW5lbC5jbGFzc0xpc3QucmVtb3ZlKCdvcGVuJyk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdwYW5lbC1hY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudG9vbC1idG4nKS5mb3JFYWNoKGIgPT4gYi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChyZXNpemVXcmFwcGVyLCAzMDApOyAvLyBSZXNldCBzbW9vdGggcmVzaXplCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICBmdW5jdGlvbiBpbml0Q2FudmFzKCkgewogICAgICAgICAgICBjYW52YXMgPSBuZXcgZmFicmljLkNhbnZhcygnYycsIHsgYmFja2dyb3VuZENvbG9yOiAnI2ZmZmZmZicsIHByZXNlcnZlT2JqZWN0U3RhY2tpbmc6IHRydWUsIHNlbGVjdGlvbjogdHJ1ZSB9KTsKICAgICAgICAgICAgZmFicmljLk9iamVjdC5wcm90b3R5cGUudHJhbnNwYXJlbnRDb3JuZXJzID0gZmFsc2U7CiAgICAgICAgICAgIGZhYnJpYy5PYmplY3QucHJvdG90eXBlLmNvcm5lckNvbG9yID0gJyNmZmZmZmYnOwogICAgICAgICAgICBmYWJyaWMuT2JqZWN0LnByb3RvdHlwZS5jb3JuZXJTdHJva2VDb2xvciA9ICcjMTU2NUMwJzsgLyogRGVlcCBCbHVlICovCiAgICAgICAgICAgIGZhYnJpYy5PYmplY3QucHJvdG90eXBlLmJvcmRlckNvbG9yID0gJyMxNTY1QzAnOyAvKiBEZWVwIEJsdWUgKi8KICAgICAgICAgICAgZmFicmljLk9iamVjdC5wcm90b3R5cGUuY29ybmVyU2l6ZSA9IDg7CiAgICAgICAgICAgIGZhYnJpYy5PYmplY3QucHJvdG90eXBlLnBhZGRpbmcgPSA0OwoKICAgICAgICAgICAgY2FudmFzLm9uKCdzZWxlY3Rpb246Y3JlYXRlZCcsIChlKSA9PiB1cGRhdGVTZWxlY3Rpb24oZS5zZWxlY3RlZFswXSkpOwogICAgICAgICAgICBjYW52YXMub24oJ3NlbGVjdGlvbjp1cGRhdGVkJywgKGUpID0+IHVwZGF0ZVNlbGVjdGlvbihlLnNlbGVjdGVkWzBdKSk7CiAgICAgICAgICAgIGNhbnZhcy5vbignc2VsZWN0aW9uOmNsZWFyZWQnLCAoKSA9PiB1cGRhdGVTZWxlY3Rpb24obnVsbCkpOwoKICAgICAgICAgICAgLy8gSGlzdG9yeSBIb29rcwogICAgICAgICAgICBjYW52YXMub24oJ29iamVjdDphZGRlZCcsICgpID0+IHNhdmVIaXN0b3J5KCkpOwogICAgICAgICAgICBjYW52YXMub24oJ29iamVjdDptb2RpZmllZCcsICgpID0+IHNhdmVIaXN0b3J5KCkpOwogICAgICAgICAgICBjYW52YXMub24oJ29iamVjdDpyZW1vdmVkJywgKCkgPT4gc2F2ZUhpc3RvcnkoKSk7CiAgICAgICAgfQoKICAgICAgICBhc3luYyBmdW5jdGlvbiBsb2FkUHJvamVjdCgpIHsKICAgICAgICAgICAgY29uc3Qgc3RvcmVkUGhvdG9zID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2NhcHR1cmVkUGhvdG9zJyk7IGlmICghc3RvcmVkUGhvdG9zKSB7IGFsZXJ0KCJObyBwaG90b3MgZm91bmQhIik7IHJldHVybjsgfSBjb25zdCBwaG90b3MgPSBKU09OLnBhcnNlKHN0b3JlZFBob3Rvcyk7CiAgICAgICAgICAgIGNvbnN0IGxheW91dElkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3NlbGVjdGVkTGF5b3V0JykgfHwgJ2NsYXNzaWNfd2hpdGUnOyBjdXJyZW50TGF5b3V0SWQgPSBsYXlvdXRJZDsgbGV0IGxheW91dCA9IGdldExheW91dENvbmZpZyhsYXlvdXRJZCkgfHwgZ2V0TGF5b3V0Q29uZmlnKCdjbGFzc2ljX3doaXRlJyk7CiAgICAgICAgICAgIGNhbnZhcy5zZXRXaWR0aChsYXlvdXQud2lkdGgpOyBjYW52YXMuc2V0SGVpZ2h0KGxheW91dC5oZWlnaHQpOyBjdXJyZW50QmdDb2xvciA9IGxheW91dC5iYWNrZ3JvdW5kQ29sb3IgfHwgJyNmZmZmZmYnOyBjYW52YXMuYmFja2dyb3VuZENvbG9yID0gY3VycmVudEJnQ29sb3I7CiAgICAgICAgICAgIGNvbnN0IGxvYWRJbWFnZSA9IChzcmMpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7IGNvbnN0IGlzRGF0YSA9IHNyYy5zdGFydHNXaXRoKCdkYXRhOicpOyBmYWJyaWMuSW1hZ2UuZnJvbVVSTChzcmMsIGltZyA9PiByZXNvbHZlKGltZyksIGlzRGF0YSA/IHVuZGVmaW5lZCA6IHsgY3Jvc3NPcmlnaW46ICdhbm9ueW1vdXMnIH0pOyB9KTsKICAgICAgICAgICAgY29uc3Qgc2xvdHMgPSBsYXlvdXQuc2xvdHMgfHwgW107CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTWF0aC5taW4oc2xvdHMubGVuZ3RoLCBwaG90b3MubGVuZ3RoKTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzbG90ID0gc2xvdHNbaV07IGNvbnN0IGltZyA9IGF3YWl0IGxvYWRJbWFnZShwaG90b3NbaV0pOyBpZiAoIWltZykgY29udGludWU7CiAgICAgICAgICAgICAgICBjb25zdCBzbG90VyA9IHNsb3QudyAqIGxheW91dC53aWR0aDsgY29uc3Qgc2xvdEggPSBzbG90LmggKiBsYXlvdXQuaGVpZ2h0OyBjb25zdCBzbG90WCA9IHNsb3QueCAqIGxheW91dC53aWR0aDsgY29uc3Qgc2xvdFkgPSBzbG90LnkgKiBsYXlvdXQuaGVpZ2h0OwogICAgICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRoLm1heChzbG90VyAvIGltZy53aWR0aCwgc2xvdEggLyBpbWcuaGVpZ2h0KTsgaW1nLnNjYWxlKHNjYWxlKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNjYWxlZFcgPSBpbWcud2lkdGggKiBzY2FsZTsgY29uc3Qgc2NhbGVkSCA9IGltZy5oZWlnaHQgKiBzY2FsZTsgY29uc3Qgb2Zmc2V0WCA9IChzY2FsZWRXIC0gc2xvdFcpIC8gMjsgY29uc3Qgb2Zmc2V0WSA9IChzY2FsZWRIIC0gc2xvdEgpIC8gMjsKICAgICAgICAgICAgICAgIGltZy5zZXQoeyBsZWZ0OiBzbG90WCAtIG9mZnNldFgsIHRvcDogc2xvdFkgLSBvZmZzZXRZLCBzZWxlY3RhYmxlOiB0cnVlLCBkYXRhOiB7IHR5cGU6ICdwaG90bycgfSB9KTsKICAgICAgICAgICAgICAgIGltZy5kYXRhLnNsb3RSZWN0ID0geyBsZWZ0OiBzbG90WCwgdG9wOiBzbG90WSwgd2lkdGg6IHNsb3RXLCBoZWlnaHQ6IHNsb3RIIH07CiAgICAgICAgICAgICAgICBjb25zdCBjbGlwID0gbmV3IGZhYnJpYy5SZWN0KHsgbGVmdDogc2xvdFgsIHRvcDogc2xvdFksIHdpZHRoOiBzbG90VywgaGVpZ2h0OiBzbG90SCwgYWJzb2x1dGVQb3NpdGlvbmVkOiB0cnVlLCByeDogbGF5b3V0LnNsb3RSYWRpdXMgfHwgMCwgcnk6IGxheW91dC5zbG90UmFkaXVzIHx8IDAgfSk7CiAgICAgICAgICAgICAgICBpbWcuY2xpcFBhdGggPSBjbGlwOwogICAgICAgICAgICAgICAgY2FudmFzLmFkZChpbWcpOwogICAgICAgICAgICAgICAgaWYgKGxheW91dC5zbG90Qm9yZGVyV2lkdGgpIHsgY29uc3QgZnJhbWUgPSBuZXcgZmFicmljLlJlY3QoeyBsZWZ0OiBzbG90WCwgdG9wOiBzbG90WSwgd2lkdGg6IHNsb3RXLCBoZWlnaHQ6IHNsb3RILCBmaWxsOiAndHJhbnNwYXJlbnQnLCBzdHJva2U6IGxheW91dC5zbG90Qm9yZGVyQ29sb3IgfHwgJyNmZmYnLCBzdHJva2VXaWR0aDogbGF5b3V0LnNsb3RCb3JkZXJXaWR0aCwgcng6IGxheW91dC5zbG90UmFkaXVzIHx8IDAsIHJ5OiBsYXlvdXQuc2xvdFJhZGl1cyB8fCAwLCBzZWxlY3RhYmxlOiBmYWxzZSwgZXZlbnRlZDogZmFsc2UgfSk7IGlmIChsYXlvdXQuc2xvdFNoYWRvdykgZnJhbWUuc2V0KCdzaGFkb3cnLCBuZXcgZmFicmljLlNoYWRvdygncmdiYSgwLDAsMCwwLjEpIDBweCA0cHggMTBweCcpKTsgY2FudmFzLmFkZChmcmFtZSk7IH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGF5b3V0Lm92ZXJsYXlUZXh0KSB7IGxheW91dC5vdmVybGF5VGV4dC5mb3JFYWNoKHQgPT4geyBjb25zdCB0eHQgPSBuZXcgZmFicmljLlRleHQodC50ZXh0LCB7IGxlZnQ6IHQueCAqIGxheW91dC53aWR0aCwgdG9wOiB0LnkgKiBsYXlvdXQuaGVpZ2h0LCBvcmlnaW5YOiAnY2VudGVyJywgb3JpZ2luWTogJ2NlbnRlcicsIGZpbGw6IHQuY29sb3IsIGZvbnRGYW1pbHk6ICdTeW5lJywgZm9udFdlaWdodDogJ2JvbGQnLCBmb250U2l6ZTogNDAsIHNlbGVjdGFibGU6IHRydWUgfSk7IGNhbnZhcy5hZGQodHh0KTsgfSk7IH0KCiAgICAgICAgICAgIHJlc2l6ZVdyYXBwZXIoKTsgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHJlc2l6ZVdyYXBwZXIpOwogICAgICAgICAgICBzYXZlSGlzdG9yeSh0cnVlKTsgLy8gSW5pdGlhbCBzdGF0ZQogICAgICAgIH0KCiAgICAgICAgLy8gLS0tIEhJU1RPUlkgRlVOQ1RJT05TIC0tLQogICAgICAgIGZ1bmN0aW9uIHNhdmVIaXN0b3J5KGZvcmNlID0gZmFsc2UpIHsKICAgICAgICAgICAgaWYgKGhpc3RvcnlQcm9jZXNzaW5nICYmICFmb3JjZSkgcmV0dXJuOwogICAgICAgICAgICAvLyBEZWJvdW5jZSBvciBzbGlnaHQgZGVsYXkgY291bGQgYmUgYWRkZWQgaGVyZSBmb3IgcGVyZm9ybWFuY2UgaWYgbmVlZGVkCgogICAgICAgICAgICAvLyBSZW1vdmUgJ2Z1dHVyZScgaGlzdG9yeSBpZiB3ZSBhcmUgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc3RhY2sKICAgICAgICAgICAgaWYgKGhpc3RvcnlTdGVwIDwgaGlzdG9yeS5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICBoaXN0b3J5ID0gaGlzdG9yeS5zbGljZSgwLCBoaXN0b3J5U3RlcCArIDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkoY2FudmFzLnRvSlNPTihbJ2RhdGEnLCAnc2VsZWN0YWJsZScsICdldmVudGVkJywgJ2Fic29sdXRlUG9zaXRpb25lZCddKSk7CiAgICAgICAgICAgIGhpc3RvcnkucHVzaChqc29uKTsKICAgICAgICAgICAgaGlzdG9yeVN0ZXArKzsKICAgICAgICAgICAgdXBkYXRlSGlzdG9yeUJ1dHRvbnMoKTsKICAgICAgICB9CgogICAgICAgIHdpbmRvdy51bmRvID0gKCkgPT4gewogICAgICAgICAgICBpZiAoaGlzdG9yeVN0ZXAgPiAwKSB7CiAgICAgICAgICAgICAgICBoaXN0b3J5UHJvY2Vzc2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICBoaXN0b3J5U3RlcC0tOwogICAgICAgICAgICAgICAgLy8gUmVzdG9yZQogICAgICAgICAgICAgICAgY2FudmFzLmxvYWRGcm9tSlNPTihoaXN0b3J5W2hpc3RvcnlTdGVwXSwgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIFJlLXJlbmRlcgogICAgICAgICAgICAgICAgICAgIGNhbnZhcy5yZW5kZXJBbGwoKTsKICAgICAgICAgICAgICAgICAgICAvLyBSZS1hdHRhY2ggY2xpcHMgb3IgZW5zdXJlIHRoZXkgYXJlIHJlc3RvcmVkIGNvcnJlY3RseT8gCiAgICAgICAgICAgICAgICAgICAgLy8gRmFicmljIHRvSlNPTiBwcmVzZXJ2ZXMgY2xpcFBhdGggc28gaXQgc2hvdWxkIGJlIGZpbmUuCiAgICAgICAgICAgICAgICAgICAgaGlzdG9yeVByb2Nlc3NpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAvLyBIb29rcyBsb3NlIGNvbnRleHQ/IE5vLCBidXQgb2JqZWN0cyBhcmUgbmV3IGluc3RhbmNlcy4KCiAgICAgICAgICAgICAgICAgICAgLy8gSU1QT1JUQU5UOiBSZS1hcHBseSBhbnkgZXh0ZXJuYWwgc3RhdGUgaWYgbmVlZGVkIChsaWtlIEJnQ29sb3IgdHJhY2tpbmcpCiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbnZhcy5iYWNrZ3JvdW5kQ29sb3IgJiYgdHlwZW9mIGNhbnZhcy5iYWNrZ3JvdW5kQ29sb3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCZ0NvbG9yID0gY2FudmFzLmJhY2tncm91bmRDb2xvcjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZUhpc3RvcnlCdXR0b25zKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5yZWRvID0gKCkgPT4gewogICAgICAgICAgICBpZiAoaGlzdG9yeVN0ZXAgPCBoaXN0b3J5Lmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgIGhpc3RvcnlQcm9jZXNzaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGhpc3RvcnlTdGVwKys7CiAgICAgICAgICAgICAgICBjYW52YXMubG9hZEZyb21KU09OKGhpc3RvcnlbaGlzdG9yeVN0ZXBdLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY2FudmFzLnJlbmRlckFsbCgpOwogICAgICAgICAgICAgICAgICAgIGhpc3RvcnlQcm9jZXNzaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlSGlzdG9yeUJ1dHRvbnMoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSGlzdG9yeUJ1dHRvbnMoKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1bmRvLWJ0bicpLmRpc2FibGVkID0gaGlzdG9yeVN0ZXAgPD0gMDsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlZG8tYnRuJykuZGlzYWJsZWQgPSBoaXN0b3J5U3RlcCA+PSBoaXN0b3J5Lmxlbmd0aCAtIDE7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZW5kZXJQYW5lbChtb2RlKSB7CiAgICAgICAgICAgIGNvbnN0IHBhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhbmVsJyk7IHBhbmVsLmlubmVySFRNTCA9ICcnOwogICAgICAgICAgICBjb25zdCBoZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgaGVhZGVyLmNsYXNzTmFtZSA9ICdwYW5lbC1oZWFkZXInOyBoZWFkZXIuaW5uZXJIVE1MID0gYDxoMj4ke21vZGV9PC9oMj5gOyBwYW5lbC5hcHBlbmRDaGlsZChoZWFkZXIpOwogICAgICAgICAgICBjb25zdCBjb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGNvbnRlbnQuY2xhc3NOYW1lID0gJ3BhbmVsLWNvbnRlbnQnOwogICAgICAgICAgICBpZiAobW9kZSA9PT0gJ3N0aWNrZXJzJykgewogICAgICAgICAgICAgICAgY29uc3QgdGFicyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyB0YWJzLmNsYXNzTmFtZSA9ICd0YWJzJzsKICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKFNUSUNLRVJTKS5mb3JFYWNoKChjYXQsIGkpID0+IHsgY29uc3QgdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyB0LmNsYXNzTmFtZSA9IGB0YWIgJHtpID09PSAwID8gJ2FjdGl2ZScgOiAnJ31gOyB0LmlubmVyVGV4dCA9IGNhdDsgdC5vbmNsaWNrID0gKCkgPT4geyBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiJykuZm9yRWFjaCh4ID0+IHguY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJykpOyB0LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOyByZW5kZXJTdGlja2VyR3JpZChjYXQsIGdyaWQpOyB9OyB0YWJzLmFwcGVuZENoaWxkKHQpOyB9KTsgY29udGVudC5hcHBlbmRDaGlsZCh0YWJzKTsKICAgICAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgZ3JpZC5jbGFzc05hbWUgPSAnZ3JpZC00JzsgY29udGVudC5hcHBlbmRDaGlsZChncmlkKTsgcmVuZGVyU3RpY2tlckdyaWQoT2JqZWN0LmtleXMoU1RJQ0tFUlMpWzBdLCBncmlkKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAndGV4dCcpIHsKICAgICAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgc3R5bGU9IndpZHRoOjEwMCU7IGp1c3RpZnktY29udGVudDpjZW50ZXIiIG9uY2xpY2s9ImFkZFRleHQoKSI+KyBBZGQgVGV4dDwvYnV0dG9uPjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+Rm9udCBTdHlsZTwvbGFiZWw+PGRpdiBjbGFzcz0iZ3JpZC0yIj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBzdHlsZT0iZm9udC1mYW1pbHk6J1BsYXlmYWlyIERpc3BsYXknIiBvbmNsaWNrPSJzZXRGb250KCdQbGF5ZmFpciBEaXNwbGF5JykiPlNlcmlmPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgc3R5bGU9ImZvbnQtZmFtaWx5OidETSBTYW5zJyIgb25jbGljaz0ic2V0Rm9udCgnRE0gU2FucycpIj5Nb2Rlcm48L2Rpdj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBzdHlsZT0iZm9udC1mYW1pbHk6J1N5bmUnIiBvbmNsaWNrPSJzZXRGb250KCdTeW5lJykiPkJvbGQ8L2Rpdj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBzdHlsZT0iZm9udC1mYW1pbHk6J091dGZpdCciIG9uY2xpY2s9InNldEZvbnQoJ091dGZpdCcpIj5DbGVhbjwvZGl2PjwvZGl2PjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+Q29sb3I8L2xhYmVsPjxpbnB1dCB0eXBlPSJjb2xvciIgb25jaGFuZ2U9InNldENvbG9yKHRoaXMudmFsdWUpIiB2YWx1ZT0iIzAwMDAwMCI+PC9kaXY+YDsKICAgICAgICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAnZHJhdycpIHsKICAgICAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+QnJ1c2ggVHlwZTwvbGFiZWw+PHNlbGVjdCBvbmNoYW5nZT0ic2V0QnJ1c2hUeXBlKHRoaXMudmFsdWUpIj48b3B0aW9uIHZhbHVlPSJQZW5jaWwiPlBlbmNpbDwvb3B0aW9uPjxvcHRpb24gdmFsdWU9IkhpZ2hsaWdodGVyIj5IaWdobGlnaHRlcjwvb3B0aW9uPjxvcHRpb24gdmFsdWU9IlNwcmF5Ij5TcHJheTwvb3B0aW9uPjxvcHRpb24gdmFsdWU9IkNpcmNsZSI+RG90czwvb3B0aW9uPjwvc2VsZWN0PjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+U2l6ZTwvbGFiZWw+PGlucHV0IHR5cGU9InJhbmdlIiBtaW49IjEiIG1heD0iNjAiIHZhbHVlPSI1IiBvbmlucHV0PSJzZXRCcnVzaFNpemUodGhpcy52YWx1ZSkiPjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+Q29sb3I8L2xhYmVsPjxpbnB1dCB0eXBlPSJjb2xvciIgb25jaGFuZ2U9InNldEJydXNoQ29sb3IodGhpcy52YWx1ZSkiPjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QiIHN0eWxlPSJ3aWR0aDoxMDAlIiBvbmNsaWNrPSJ0b2dnbGVEcmF3KGZhbHNlKSI+U3RvcCBEcmF3aW5nPC9idXR0b24+PGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IiBzdHlsZT0id2lkdGg6MTAwJTsgbWFyZ2luLXRvcDoxMHB4OyIgb25jbGljaz0idG9nZ2xlRHJhdyh0cnVlKSI+U3RhcnQgRHJhd2luZzwvYnV0dG9uPjwvZGl2PmA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2ZpbHRlcnMnKSB7CiAgICAgICAgICAgICAgICBpZiAoYWN0aXZlT2JqZWN0ICYmIGFjdGl2ZU9iamVjdC5kYXRhICYmIGFjdGl2ZU9iamVjdC5kYXRhLnR5cGUgPT09ICdwaG90bycpIHsKICAgICAgICAgICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJjb250cm9sLWxhYmVsIj5QaG90byBTaGFwZTwvZGl2PjxkaXYgY2xhc3M9ImdyaWQtMyIgc3R5bGU9Im1hcmdpbi1ib3R0b206MjRweDsiPjxkaXYgY2xhc3M9ImZpbHRlci1idG4iIG9uY2xpY2s9Im1hc2tQaG90bygncmVjdCcpIj7il7w8L2Rpdj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBvbmNsaWNrPSJtYXNrUGhvdG8oJ2NpcmNsZScpIj7il488L2Rpdj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBvbmNsaWNrPSJtYXNrUGhvdG8oJ2hlYXJ0JykiPuKZpTwvZGl2PjxkaXYgY2xhc3M9ImZpbHRlci1idG4iIG9uY2xpY2s9Im1hc2tQaG90bygnZmxvd2VyJykiPuKcvzwvZGl2PjxkaXYgY2xhc3M9ImZpbHRlci1idG4iIG9uY2xpY2s9Im1hc2tQaG90bygnc3RhcicpIj7imIU8L2Rpdj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBvbmNsaWNrPSJtYXNrUGhvdG8oJ2Nsb3VkJykiPuKYge+4jzwvZGl2PjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPkZpbHRlcnM8L2Rpdj48ZGl2IGNsYXNzPSJncmlkLTIiIGlkPSJmaWx0ZXItZ3JpZCI+PC9kaXY+YDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IGNvbnRlbnQuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPkZpbHRlcnM8L2Rpdj48ZGl2IGNsYXNzPSJncmlkLTIiIGlkPSJmaWx0ZXItZ3JpZCI+PC9kaXY+YDsgfQogICAgICAgICAgICAgICAgY29uc3QgZmcgPSBjb250ZW50LnF1ZXJ5U2VsZWN0b3IoJyNmaWx0ZXItZ3JpZCcpOwogICAgICAgICAgICAgICAgWydOb25lJywgJ0dyYXlzY2FsZScsICdTZXBpYScsICdWaW50YWdlJywgJ1RlY2huaWNvbG9yJywgJ1BvbGFyb2lkJywgJ0ludmVydCddLmZvckVhY2goZiA9PiB7IGNvbnN0IGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgYi5jbGFzc05hbWUgPSAnZmlsdGVyLWJ0bic7IGIuaW5uZXJUZXh0ID0gZjsgYi5vbmNsaWNrID0gKCkgPT4gYXBwbHlGaWx0ZXIoZik7IGZnLmFwcGVuZENoaWxkKGIpOyB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAnYmFja2dyb3VuZCcpIHsKICAgICAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+U29saWQgQ29sb3I8L2xhYmVsPjxpbnB1dCB0eXBlPSJjb2xvciIgb25jaGFuZ2U9InNldEJnQ29sb3IodGhpcy52YWx1ZSkiIHZhbHVlPSIke2N1cnJlbnRCZ0NvbG9yfSI+PC9kaXY+PGRpdiBjbGFzcz0iY29udHJvbC1ncm91cCI+PGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj5QYXR0ZXJuczwvbGFiZWw+PGRpdiBjbGFzcz0iZ3JpZC0yIj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBvbmNsaWNrPSJzZXRQYXR0ZXJuKG51bGwpIj5Ob25lPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ic2V0UGF0dGVybignRG90cycpIj5Eb3RzPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ic2V0UGF0dGVybignU3RyaXBlcycpIj5TdHJpcGVzPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ic2V0UGF0dGVybignR3JpZCcpIj5HcmlkPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ic2V0UGF0dGVybignQ2hlY2snKSI+Q2hlY2s8L2Rpdj48L2Rpdj48L2Rpdj5gOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdtYWdpYycpIHsKICAgICAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+QUkgRWZmZWN0czwvbGFiZWw+PGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1naG9zdCIgc3R5bGU9IndpZHRoOjEwMCU7IG1hcmdpbi1ib3R0b206MTJweCIgb25jbGljaz0ibWFnaWNSZW1peCgpIj7inKggQXV0byBSZW1peDwvYnV0dG9uPjxkaXYgY2xhc3M9ImdyaWQtMiI+PGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1naG9zdCIgc3R5bGU9ImZvbnQtc2l6ZTowLjc1cmVtIiBvbmNsaWNrPSJhcHBseU1hZ2ljKCdkdW90b25lJykiPvCfjqggRHVvdG9uZTwvYnV0dG9uPjxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QiIHN0eWxlPSJmb250LXNpemU6MC43NXJlbSIgb25jbGljaz0iYXBwbHlNYWdpYygnY3liZXInKSI+8J+RviBDeWJlcjwvYnV0dG9uPjxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QiIHN0eWxlPSJmb250LXNpemU6MC43NXJlbSIgb25jbGljaz0iYXBwbHlNYWdpYygnbm9zdGFsZ2lhJykiPvCflbDvuI8gTm9zdGFsZ2lhPC9idXR0b24+PGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1naG9zdCIgc3R5bGU9ImZvbnQtc2l6ZTowLjc1cmVtIiBvbmNsaWNrPSJhZGRDb25mZXR0aSgpIj7wn46JIENvbmZldHRpPC9idXR0b24+PC9kaXY+PC9kaXY+YDsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYW5lbC5hcHBlbmRDaGlsZChjb250ZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyU3RpY2tlckdyaWQoY2F0LCBjb250YWluZXIpIHsgY29udGFpbmVyLmlubmVySFRNTCA9ICcnOyAoU1RJQ0tFUlNbY2F0XSB8fCBbXSkuZm9yRWFjaChzID0+IHsgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgZWwuY2xhc3NOYW1lID0gJ2l0ZW0tYm94JzsgZWwuaW5uZXJUZXh0ID0gczsgZWwub25jbGljayA9ICgpID0+IHsgYWRkU3RpY2tlcihzKTsgfTsgY29udGFpbmVyLmFwcGVuZENoaWxkKGVsKTsgfSk7IH0KICAgICAgICBmdW5jdGlvbiBzZXR1cFRvb2xiYXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGJ0bnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudG9vbC1idG4nKTsKICAgICAgICAgICAgY29uc3QgcGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFuZWwnKTsKCiAgICAgICAgICAgIGJ0bnMuZm9yRWFjaChiID0+IHsKICAgICAgICAgICAgICAgIGIub25jbGljayA9ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3YXNBY3RpdmUgPSBiLmNsYXNzTGlzdC5jb250YWlucygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQYW5lbE9wZW4gPSBwYW5lbC5jbGFzc0xpc3QuY29udGFpbnMoJ29wZW4nKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgY2xpY2tpbmcgYWN0aXZlIGJ1dHRvbiwgdG9nZ2xlIHBhbmVsIChjbG9zZSBpdCkKICAgICAgICAgICAgICAgICAgICBpZiAod2FzQWN0aXZlICYmIGlzUGFuZWxPcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhbmVsLmNsYXNzTGlzdC5yZW1vdmUoJ29wZW4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgYi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdwYW5lbC1hY3RpdmUnKTsgLy8gUmVtb3ZlIHNoaWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVzaXplV3JhcHBlciwgMzAwKTsgLy8gUmUtY2VudGVyIGNhbnZhcwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBidG5zLmZvckVhY2goeCA9PiB4LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpKTsKICAgICAgICAgICAgICAgICAgICBiLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHJlbmRlclBhbmVsKGIuZGF0YXNldC5pZCk7CgogICAgICAgICAgICAgICAgICAgIC8vIE9wZW4gcGFuZWwKICAgICAgICAgICAgICAgICAgICBwYW5lbC5jbGFzc0xpc3QuYWRkKCdvcGVuJyk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdwYW5lbC1hY3RpdmUnKTsgLy8gU2hpZnQgc3RhZ2UgdXAKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHJlc2l6ZVdyYXBwZXIsIDMwMCk7IC8vIFJlLXNjYWxlIGNhbnZhcyB0byBuZXcgYXZhaWxhYmxlIGhlaWdodAoKICAgICAgICAgICAgICAgICAgICBpZiAoYi5kYXRhc2V0LmlkICE9PSAnZHJhdycpIHRvZ2dsZURyYXcoZmFsc2UpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBDbGVhbiB1cCBzdGFnZSBjbGljayAoY2xvc2UgcGFuZWwpCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGFnZScpLm9uY2xpY2sgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgLy8gT25seSBjbG9zZSBpZiBjbGlja2luZyBzdGFnZSBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXQuaWQgPT09ICdzdGFnZScgfHwgZS50YXJnZXQuaWQgPT09ICdjYW52YXMtd3JhcHBlcicpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFuZWwnKS5jbGFzc0xpc3QucmVtb3ZlKCdvcGVuJyk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdwYW5lbC1hY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudG9vbC1idG4nKS5mb3JFYWNoKGIgPT4gYi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChyZXNpemVXcmFwcGVyLCAzMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgd2luZG93LmFkZFN0aWNrZXIgPSAocykgPT4geyBjb25zdCB0ID0gbmV3IGZhYnJpYy5UZXh0KHMsIHsgbGVmdDogNDAwLCB0b3A6IDQwMCwgZm9udFNpemU6IDgwLCBvcmlnaW5YOiAnY2VudGVyJywgb3JpZ2luWTogJ2NlbnRlcicgfSk7IGNhbnZhcy5hZGQodCk7IGNhbnZhcy5zZXRBY3RpdmVPYmplY3QodCk7IH07CiAgICAgICAgd2luZG93LmFkZFRleHQgPSAoKSA9PiB7IGNvbnN0IHQgPSBuZXcgZmFicmljLklUZXh0KCJUeXBlIEhlcmUiLCB7IGxlZnQ6IDQwMCwgdG9wOiA0MDAsIGZvbnRGYW1pbHk6ICdETSBTYW5zJywgZm9udFNpemU6IDYwLCBmaWxsOiAnIzAwMCcsIG9yaWdpblg6ICdjZW50ZXInLCBvcmlnaW5ZOiAnY2VudGVyJyB9KTsgY2FudmFzLmFkZCh0KTsgY2FudmFzLnNldEFjdGl2ZU9iamVjdCh0KTsgdC5lbnRlckVkaXRpbmcoKTsgfTsKICAgICAgICB3aW5kb3cuc2V0Rm9udCA9IChmKSA9PiB7IGNvbnN0IG8gPSBjYW52YXMuZ2V0QWN0aXZlT2JqZWN0KCk7IGlmIChvICYmIG8uc2V0KSB7IG8uc2V0KCdmb250RmFtaWx5JywgZik7IGNhbnZhcy5yZXF1ZXN0UmVuZGVyQWxsKCk7IH0gfTsKICAgICAgICB3aW5kb3cuc2V0Q29sb3IgPSAoYykgPT4geyBjb25zdCBvID0gY2FudmFzLmdldEFjdGl2ZU9iamVjdCgpOyBpZiAobyAmJiBvLnNldCkgeyBvLnNldCgnZmlsbCcsIGMpOyBjYW52YXMucmVxdWVzdFJlbmRlckFsbCgpOyB9IH07CiAgICAgICAgd2luZG93LnNldEJnQ29sb3IgPSAoYykgPT4geyBjdXJyZW50QmdDb2xvciA9IGM7IGFwcGx5QmFja2dyb3VuZCgpOyBzYXZlSGlzdG9yeSgpOyB9OyAvLyBNYW51YWwgU2F2ZQogICAgICAgIHdpbmRvdy5zZXRQYXR0ZXJuID0gKG5hbWUpID0+IHsgY3VycmVudFBhdHRlcm4gPSBuYW1lOyBhcHBseUJhY2tncm91bmQoKTsgc2F2ZUhpc3RvcnkoKTsgfTsgLy8gTWFudWFsIFNhdmUKICAgICAgICBmdW5jdGlvbiBhcHBseUJhY2tncm91bmQoKSB7IGlmICghY3VycmVudFBhdHRlcm4pIHsgY2FudmFzLnNldEJhY2tncm91bmRDb2xvcihjdXJyZW50QmdDb2xvciwgY2FudmFzLnJlbmRlckFsbC5iaW5kKGNhbnZhcykpOyB9IGVsc2UgeyBjb25zdCBwYXR0ZXJuRGVmID0gUEFUVEVSTlMuZmluZChwID0+IHAubmFtZSA9PT0gY3VycmVudFBhdHRlcm4pOyBpZiAocGF0dGVybkRlZikgeyBjb25zdCBwQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7IHBDYW52YXMud2lkdGggPSAyMDsgcENhbnZhcy5oZWlnaHQgPSAyMDsgY29uc3QgcEN0eCA9IHBDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsgcEN0eC5maWxsU3R5bGUgPSBjdXJyZW50QmdDb2xvcjsgcEN0eC5maWxsUmVjdCgwLCAwLCAyMCwgMjApOyBwYXR0ZXJuRGVmLmRyYXcocEN0eCwgMjAsIDIwKTsgY2FudmFzLnNldEJhY2tncm91bmRDb2xvcihuZXcgZmFicmljLlBhdHRlcm4oeyBzb3VyY2U6IHBDYW52YXMsIHJlcGVhdDogJ3JlcGVhdCcgfSksIGNhbnZhcy5yZW5kZXJBbGwuYmluZChjYW52YXMpKTsgfSB9IH0KCiAgICAgICAgd2luZG93LnRvZ2dsZURyYXcgPSAoZW5hYmxlKSA9PiB7IGNhbnZhcy5pc0RyYXdpbmdNb2RlID0gZW5hYmxlOyBpZiAoZW5hYmxlKSB7IGlmICghY2FudmFzLmZyZWVEcmF3aW5nQnJ1c2gpIGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoID0gbmV3IGZhYnJpYy5QZW5jaWxCcnVzaChjYW52YXMpOyBjYW52YXMuZnJlZURyYXdpbmdCcnVzaC53aWR0aCA9IDEwOyBjYW52YXMuZnJlZURyYXdpbmdCcnVzaC5jb2xvciA9ICIjMDAwIjsgfSB9OwogICAgICAgIHdpbmRvdy5zZXRCcnVzaFR5cGUgPSAodHlwZSkgPT4gewogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1BlbmNpbCcpIGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoID0gbmV3IGZhYnJpYy5QZW5jaWxCcnVzaChjYW52YXMpOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ0NpcmNsZScpIGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoID0gbmV3IGZhYnJpYy5DaXJjbGVCcnVzaChjYW52YXMpOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NwcmF5JykgY2FudmFzLmZyZWVEcmF3aW5nQnJ1c2ggPSBuZXcgZmFicmljLlNwcmF5QnJ1c2goY2FudmFzKTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdIaWdobGlnaHRlcicpIHsKICAgICAgICAgICAgICAgIGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoID0gbmV3IGZhYnJpYy5QZW5jaWxCcnVzaChjYW52YXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaW5wdXRbdHlwZT0iY29sb3IiXScpPy52YWx1ZSB8fCAiIzAwMCI7CiAgICAgICAgICAgIGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoLmNvbG9yID0gdHlwZSA9PT0gJ0hpZ2hsaWdodGVyJyA/IGNvbG9yICsgJzU1JyA6IGNvbG9yOwogICAgICAgICAgICBjYW52YXMuZnJlZURyYXdpbmdCcnVzaC53aWR0aCA9IHR5cGUgPT09ICdIaWdobGlnaHRlcicgPyAzMCA6IDEwOwogICAgICAgIH07CiAgICAgICAgd2luZG93LnNldEJydXNoU2l6ZSA9ICh2KSA9PiB7IGlmIChjYW52YXMuZnJlZURyYXdpbmdCcnVzaCkgY2FudmFzLmZyZWVEcmF3aW5nQnJ1c2gud2lkdGggPSBwYXJzZUludCh2LCAxMCk7IH07CiAgICAgICAgd2luZG93LnNldEJydXNoQ29sb3IgPSAoYykgPT4geyBpZiAoY2FudmFzLmZyZWVEcmF3aW5nQnJ1c2gpIGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoLmNvbG9yID0gYzsgfTsKCiAgICAgICAgLy8gRklYOiBNYXNraW5nIExvZ2ljIChBYnNvbHV0ZSBQb3NpdGlvbmluZykKICAgICAgICB3aW5kb3cubWFza1Bob3RvID0gKHNoYXBlKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IG9iaiA9IGNhbnZhcy5nZXRBY3RpdmVPYmplY3QoKTsKICAgICAgICAgICAgaWYgKCFvYmogfHwgb2JqLmRhdGEudHlwZSAhPT0gJ3Bob3RvJykgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBzbG90ID0gb2JqLmRhdGEuc2xvdFJlY3Q7CiAgICAgICAgICAgIGNvbnN0IGN4ID0gc2xvdC5sZWZ0ICsgc2xvdC53aWR0aCAvIDI7CiAgICAgICAgICAgIGNvbnN0IGN5ID0gc2xvdC50b3AgKyBzbG90LmhlaWdodCAvIDI7CiAgICAgICAgICAgIGNvbnN0IHNpemUgPSBNYXRoLm1pbihzbG90LndpZHRoLCBzbG90LmhlaWdodCk7CgogICAgICAgICAgICBsZXQgY2xpcFBhdGg7CiAgICAgICAgICAgIGlmIChzaGFwZSA9PT0gJ3JlY3QnKSBjbGlwUGF0aCA9IG5ldyBmYWJyaWMuUmVjdCh7IGxlZnQ6IHNsb3QubGVmdCwgdG9wOiBzbG90LnRvcCwgd2lkdGg6IHNsb3Qud2lkdGgsIGhlaWdodDogc2xvdC5oZWlnaHQsIGFic29sdXRlUG9zaXRpb25lZDogdHJ1ZSB9KTsKICAgICAgICAgICAgZWxzZSBpZiAoc2hhcGUgPT09ICdjaXJjbGUnKSBjbGlwUGF0aCA9IG5ldyBmYWJyaWMuQ2lyY2xlKHsgcmFkaXVzOiBzaXplIC8gMiwgbGVmdDogY3gsIHRvcDogY3ksIG9yaWdpblg6ICdjZW50ZXInLCBvcmlnaW5ZOiAnY2VudGVyJywgYWJzb2x1dGVQb3NpdGlvbmVkOiB0cnVlIH0pOwogICAgICAgICAgICBlbHNlIGlmIChzaGFwZSA9PT0gJ2hlYXJ0JykgewogICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9ICJNIDAgLTMwIEMgLTIwIC01MCAtNTAgLTMwIC0zMCAwIEwgMCAzMCBMIDMwIDAgQyA1MCAtMzAgMjAgLTUwIDAgLTMwIFoiOwogICAgICAgICAgICAgICAgY2xpcFBhdGggPSBuZXcgZmFicmljLlBhdGgocGF0aCwgeyBzY2FsZVg6IHNpemUgLyA3MCwgc2NhbGVZOiBzaXplIC8gNzAsIGxlZnQ6IGN4LCB0b3A6IGN5LCBvcmlnaW5YOiAnY2VudGVyJywgb3JpZ2luWTogJ2NlbnRlcicsIGFic29sdXRlUG9zaXRpb25lZDogdHJ1ZSB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChzaGFwZSA9PT0gJ3N0YXInKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwYXRoID0gIk0gMCAtNTAgTCAxMiAtMTUgTCA0OCAtMTUgTCAxOCA4IEwgMjkgNDIgTCAwIDI1IEwgLTI5IDQyIEwgLTE4IDggTCAtNDggLTE1IEwgLTEyIC0xNSBaIjsKICAgICAgICAgICAgICAgIGNsaXBQYXRoID0gbmV3IGZhYnJpYy5QYXRoKHBhdGgsIHsgc2NhbGVYOiBzaXplIC8gMTAwLCBzY2FsZVk6IHNpemUgLyAxMDAsIGxlZnQ6IGN4LCB0b3A6IGN5LCBvcmlnaW5YOiAnY2VudGVyJywgb3JpZ2luWTogJ2NlbnRlcicsIGFic29sdXRlUG9zaXRpb25lZDogdHJ1ZSB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChzaGFwZSA9PT0gJ2Zsb3dlcicpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBhdGggPSAiTSAwIDAgQyAwIC0xMCAtMTAgLTIwIDAgLTMwIEMgMTAgLTQwIDIwIC0zMCAzMCAtNDAgQyA0MCAtMzAgMzAgLTIwIDQwIC0xMCBDIDUwIDAgNDAgMTAgMzAgMjAgQyA0MCAzMCAzMCA0MCAyMCAzMCBDIDEwIDQwIDAgMzAgLTEwIDQwIEMgLTIwIDMwIC0zMCA0MCAtNDAgMzAgQyAtNTAgNDAgLTQwIDIwIC01MCAxMCBDIC00MCAwIC01MCAtMTAgLTQwIC0yMCBDIC0zMCAtMzAgLTIwIC0yMCAtMTAgLTMwIFoiOwogICAgICAgICAgICAgICAgY2xpcFBhdGggPSBuZXcgZmFicmljLlBhdGgocGF0aCwgeyBzY2FsZVg6IHNpemUgLyAxMDAsIHNjYWxlWTogc2l6ZSAvIDEwMCwgbGVmdDogY3gsIHRvcDogY3ksIG9yaWdpblg6ICdjZW50ZXInLCBvcmlnaW5ZOiAnY2VudGVyJywgYWJzb2x1dGVQb3NpdGlvbmVkOiB0cnVlIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHNoYXBlID09PSAnY2xvdWQnKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwYXRoID0gIk0gMjUsNjAgYSAyMCwyMCAwIDAsMSAwLC00MCBhIDIwLDIwIDAgMCwxIDQwLC0xMCBhIDIwLDIwIDAgMCwxIDQwLDEwIGEgMjAsMjAgMCAwLDEgMCw0MCB6IjsKICAgICAgICAgICAgICAgIGNsaXBQYXRoID0gbmV3IGZhYnJpYy5QYXRoKHBhdGgsIHsgc2NhbGVYOiBzaXplIC8gMTIwLCBzY2FsZVk6IHNpemUgLyAxMDAsIGxlZnQ6IGN4LCB0b3A6IGN5LCBvcmlnaW5YOiAnY2VudGVyJywgb3JpZ2luWTogJ2NlbnRlcicsIGFic29sdXRlUG9zaXRpb25lZDogdHJ1ZSB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsaXBQYXRoKSB7CiAgICAgICAgICAgICAgICBvYmouY2xpcFBhdGggPSBjbGlwUGF0aDsKICAgICAgICAgICAgICAgIG9iai5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICBjYW52YXMucmVxdWVzdFJlbmRlckFsbCgpOwogICAgICAgICAgICAgICAgc2F2ZUhpc3RvcnkoKTsgLy8gQXV0byBTYXZlCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5wcmludFBob3RvID0gKCkgPT4gewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY2FudmFzLmRpc2NhcmRBY3RpdmVPYmplY3QoKTsKICAgICAgICAgICAgICAgIGNhbnZhcy5yZW5kZXJBbGwoKTsKCiAgICAgICAgICAgICAgICBjb25zdCBkYXRhVVJMID0gY2FudmFzLnRvRGF0YVVSTCh7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0OiAncG5nJywKICAgICAgICAgICAgICAgICAgICBxdWFsaXR5OiAxLAogICAgICAgICAgICAgICAgICAgIG11bHRpcGxpZXI6IDIKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHBhcmVudC5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogIlBSSU5UX1NUUklQIiwKICAgICAgICAgICAgICAgICAgICBpbWFnZTogZGF0YVVSTAogICAgICAgICAgICAgICAgfSwgd2luZG93LmxvY2F0aW9uLm9yaWdpbik7CgogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBhbGVydCgiUHJpbnQgZmFpbGVkOiAiICsgZS5tZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKCiAgICAgICAgd2luZG93LmFwcGx5RmlsdGVyID0gKG5hbWUpID0+IHsKICAgICAgICAgICAgY29uc3Qgb2JqID0gY2FudmFzLmdldEFjdGl2ZU9iamVjdCgpOyBpZiAoIW9iaiB8fCAhb2JqLmZpbHRlcnMpIHJldHVybjsgb2JqLmZpbHRlcnMgPSBbXTsKICAgICAgICAgICAgaWYgKG5hbWUgIT09ICdOb25lJykgewogICAgICAgICAgICAgICAgY29uc3QgZk1hcCA9IHsgJ0dyYXlzY2FsZSc6IG5ldyBmYWJyaWMuSW1hZ2UuZmlsdGVycy5HcmF5c2NhbGUoKSwgJ1NlcGlhJzogbmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLlNlcGlhKCksICdJbnZlcnQnOiBuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuSW52ZXJ0KCksICdWaW50YWdlJzogbmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLk5vaXNlKHsgbm9pc2U6IDUwIH0pLCAnVGVjaG5pY29sb3InOiBuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuVGVjaG5pY29sb3IoKSwgJ1BvbGFyb2lkJzogbmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLlBvbGFyb2lkKCkgfTsKICAgICAgICAgICAgICAgIGlmIChmTWFwW25hbWVdKSBvYmouZmlsdGVycy5wdXNoKGZNYXBbbmFtZV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9iai5hcHBseUZpbHRlcnMoKTsgY2FudmFzLnJlcXVlc3RSZW5kZXJBbGwoKTsKICAgICAgICAgICAgc2F2ZUhpc3RvcnkoKTsgLy8gQXV0byBTYXZlCiAgICAgICAgfTsKCiAgICAgICAgd2luZG93Lm1hZ2ljUmVtaXggPSAoKSA9PiB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzID0gU1RJQ0tFUlNbJ1ZpYmVzJ11bTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogU1RJQ0tFUlNbJ1ZpYmVzJ10ubGVuZ3RoKV07CiAgICAgICAgICAgICAgICBjb25zdCB0ID0gbmV3IGZhYnJpYy5UZXh0KHMsIHsgbGVmdDogTWF0aC5yYW5kb20oKSAqIGNhbnZhcy53aWR0aCwgdG9wOiBNYXRoLnJhbmRvbSgpICogY2FudmFzLmhlaWdodCwgZm9udFNpemU6IDYwIH0pOwogICAgICAgICAgICAgICAgY2FudmFzLmFkZCh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzYXZlSGlzdG9yeSgpOyAvLyBBdXRvIFNhdmUKICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRDb25mZXR0aSA9ICgpID0+IHsgZm9yIChsZXQgaSA9IDA7IGkgPCAyMDsgaSsrKSB7IGNvbnN0IGNvbG9yID0gYGhzbCgke01hdGgucmFuZG9tKCkgKiAzNjB9LCAxMDAlLCA1MCUpYDsgY29uc3Qgc2hhcGUgPSBNYXRoLnJhbmRvbSgpID4gMC41ID8gbmV3IGZhYnJpYy5DaXJjbGUoeyByYWRpdXM6IE1hdGgucmFuZG9tKCkgKiAxMCArIDUsIGZpbGw6IGNvbG9yLCBsZWZ0OiBNYXRoLnJhbmRvbSgpICogY2FudmFzLndpZHRoLCB0b3A6IE1hdGgucmFuZG9tKCkgKiBjYW52YXMuaGVpZ2h0IH0pIDogbmV3IGZhYnJpYy5SZWN0KHsgd2lkdGg6IE1hdGgucmFuZG9tKCkgKiAyMCArIDEwLCBoZWlnaHQ6IE1hdGgucmFuZG9tKCkgKiAyMCArIDEwLCBmaWxsOiBjb2xvciwgbGVmdDogTWF0aC5yYW5kb20oKSAqIGNhbnZhcy53aWR0aCwgdG9wOiBNYXRoLnJhbmRvbSgpICogY2FudmFzLmhlaWdodCwgYW5nbGU6IE1hdGgucmFuZG9tKCkgKiAzNjAgfSk7IGNhbnZhcy5hZGQoc2hhcGUpOyB9IGNhbnZhcy5yZXF1ZXN0UmVuZGVyQWxsKCk7IHNhdmVIaXN0b3J5KCk7IH07CgogICAgICAgIHdpbmRvdy5hcHBseU1hZ2ljID0gKHR5cGUpID0+IHsKICAgICAgICAgICAgY29uc3Qgb2JqID0gY2FudmFzLmdldEFjdGl2ZU9iamVjdCgpOwogICAgICAgICAgICBpZiAoIW9iaiB8fCAhb2JqLmZpbHRlcnMpIHJldHVybjsKICAgICAgICAgICAgb2JqLmZpbHRlcnMgPSBbXTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdkdW90b25lJykgewogICAgICAgICAgICAgICAgb2JqLmZpbHRlcnMucHVzaChuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuR3JheXNjYWxlKCkpOwogICAgICAgICAgICAgICAgb2JqLmZpbHRlcnMucHVzaChuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuQmxlbmRDb2xvcih7IGNvbG9yOiAnI0ZGMDBGRicsIG1vZGU6ICdzY3JlZW4nIH0pKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnY3liZXInKSB7CiAgICAgICAgICAgICAgICBvYmouZmlsdGVycy5wdXNoKG5ldyBmYWJyaWMuSW1hZ2UuZmlsdGVycy5Db250cmFzdCh7IGNvbnRyYXN0OiAwLjMgfSkpOwogICAgICAgICAgICAgICAgb2JqLmZpbHRlcnMucHVzaChuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuU2F0dXJhdGlvbih7IHNhdHVyYXRpb246IDAuNSB9KSk7CiAgICAgICAgICAgICAgICAvLyBHcmVlbiBUaW50CiAgICAgICAgICAgICAgICBvYmouZmlsdGVycy5wdXNoKG5ldyBmYWJyaWMuSW1hZ2UuZmlsdGVycy5CbGVuZENvbG9yKHsgY29sb3I6ICcjMDBGRjAwJywgbW9kZTogJ292ZXJsYXknLCBhbHBoYTogMC4yIH0pKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbm9zdGFsZ2lhJykgewogICAgICAgICAgICAgICAgb2JqLmZpbHRlcnMucHVzaChuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuU2VwaWEoKSk7CiAgICAgICAgICAgICAgICBvYmouZmlsdGVycy5wdXNoKG5ldyBmYWJyaWMuSW1hZ2UuZmlsdGVycy5Ob2lzZSh7IG5vaXNlOiAxMDAgfSkpOwogICAgICAgICAgICAgICAgb2JqLmZpbHRlcnMucHVzaChuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuQ29udHJhc3QoeyBjb250cmFzdDogLTAuMSB9KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2JqLmFwcGx5RmlsdGVycygpOwogICAgICAgICAgICBjYW52YXMucmVxdWVzdFJlbmRlckFsbCgpOwogICAgICAgICAgICBzYXZlSGlzdG9yeSgpOwogICAgICAgIH07CgogICAgICAgIHdpbmRvdy51cGRhdGVTZWxlY3Rpb24gPSAob2JqKSA9PiB7IGFjdGl2ZU9iamVjdCA9IG9iajsgcmVuZGVyUGFuZWwoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnRvb2wtYnRuLmFjdGl2ZScpLmRhdGFzZXQuaWQpOyB9OwogICAgICAgIGZ1bmN0aW9uIHJlc2l6ZVdyYXBwZXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhZ2UnKTsKICAgICAgICAgICAgY29uc3QgdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYW52YXMtd3JhcHBlcicpOwogICAgICAgICAgICBpZiAoIWMgfHwgIXcgfHwgIWNhbnZhcykgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgY3cgPSBjYW52YXMuZ2V0V2lkdGgoKTsKICAgICAgICAgICAgY29uc3QgY2ggPSBjYW52YXMuZ2V0SGVpZ2h0KCk7CiAgICAgICAgICAgIHcuc3R5bGUud2lkdGggPSBjdyArICdweCc7CiAgICAgICAgICAgIHcuc3R5bGUuaGVpZ2h0ID0gY2ggKyAncHgnOwoKICAgICAgICAgICAgbGV0IGF2YWlsYWJsZUggPSBjLmNsaWVudEhlaWdodCAtIDQwOwogICAgICAgICAgICAvLyBTdWJ0cmFjdCBwYW5lbCBoZWlnaHQgaWYgb3BlbgogICAgICAgICAgICBpZiAoZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuY29udGFpbnMoJ3BhbmVsLWFjdGl2ZScpKSB7CiAgICAgICAgICAgICAgICBhdmFpbGFibGVIIC09IDM0MDsgLy8gQXBwcm94IGhlaWdodCBvZiBwcm9wZXJ0aWVzIHBhbmVsCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFsbG93IG1vcmUgd2lkdGggdXNhZ2Ugb24gbW9iaWxlCiAgICAgICAgICAgIGNvbnN0IGF2YWlsYWJsZVcgPSBjLmNsaWVudFdpZHRoIC0gKHdpbmRvdy5pbm5lcldpZHRoIDwgNjAwID8gMTAgOiA0MCk7CgogICAgICAgICAgICBjb25zdCBzY2FsZSA9IE1hdGgubWluKGF2YWlsYWJsZVcgLyBjdywgYXZhaWxhYmxlSCAvIGNoKTsKCiAgICAgICAgICAgIHcuc3R5bGUudHJhbnNmb3JtID0gYHNjYWxlKCR7TWF0aC5tYXgoMC4xLCBzY2FsZSl9KWA7IC8vIFByZXZlbnQgaW52YWxpZCBzY2FsZQoKICAgICAgICAgICAgLy8gQWRqdXN0IHRyYW5zZm9ybSBvcmlnaW4gZm9yIHNtb290aGVyIFVYCiAgICAgICAgICAgIHcuc3R5bGUudHJhbnNmb3JtT3JpZ2luID0gZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuY29udGFpbnMoJ3BhbmVsLWFjdGl2ZScpID8gJ2NlbnRlciB0b3AnIDogJ2NlbnRlciBjZW50ZXInOwogICAgICAgICAgICB3LnN0eWxlLm1hcmdpblRvcCA9IGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmNvbnRhaW5zKCdwYW5lbC1hY3RpdmUnKSA/ICcyMHB4JyA6ICcwJzsKICAgICAgICB9CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NhdmUtYnRuJykub25jbGljayA9ICgpID0+IHsgY2FudmFzLmRpc2NhcmRBY3RpdmVPYmplY3QoKTsgY2FudmFzLnJlcXVlc3RSZW5kZXJBbGwoKTsgY29uc3QgdXJsID0gY2FudmFzLnRvRGF0YVVSTCh7IGZvcm1hdDogJ3BuZycsIG11bHRpcGxpZXI6IDIgfSk7IGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7IGEuZG93bmxvYWQgPSAncGhvdG9ib290aC1wcm8ucG5nJzsgYS5ocmVmID0gdXJsOyBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpOyBhLmNsaWNrKCk7IGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoYSk7IH07CgogICAgPC9zY3JpcHQ+Cg==";
            var d = atob(e); // Decode
            // Safe injection:
            document.body.innerHTML = d;
            
            // Restore visibility
            document.body.style.visibility = 'visible'; 
            document.body.style.opacity = '1';
            
            // Re-run scripts in the injected content? 
            // innerHTML does NOT execute <script> tags automatically.
            // We need to manually execute them.
            
            var scripts = document.body.getElementsByTagName("script");
            for (var i = 0; i < scripts.length; i++) {
                var oldScript = scripts[i];
                var newScript = document.createElement("script");
                newScript.text = oldScript.text;
                if (oldScript.src) newScript.src = oldScript.src;
                if (oldScript.type) newScript.type = oldScript.type;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            }
            
            console.log("Secure Content Loaded");
        })();
    </script>
</body>
</html>