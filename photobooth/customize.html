<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Photo Time | Customize</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
        :root {
            --bg-dark: #0a0a0f;
            --panel-bg: #1a1a2e;
            --accent: #6A5ACD;
            --accent-glow: rgba(106, 90, 205, 0.4);
            --text-light: #FDFCF8;
            --toolbar-h: 70px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'DM Sans', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- LAYOUT --- */
        #app {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100%;
            width: 100%;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(10px);
            z-index: 50;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            color: #fff;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .finish-btn {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        /* --- MAIN CANVAS STAGE --- */
        #stage-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image:
                radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .canvas-wrapper {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* --- TOOLBARS --- */
        /* Desktop Sidebar (Left) - Hidden on Mobile */
        .desktop-sidebar {
            display: none;
            width: 80px;
            background: var(--panel-bg);
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            gap: 20px;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Mobile Bottom Bar - Visible on Mobile */
        .mobile-nav {
            height: var(--toolbar-h);
            background: var(--panel-bg);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: 5px;
            /* Home indicator safe area */
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 50;
        }

        .tool-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .tool-btn.active {
            color: var(--accent);
        }

        .tool-btn.active svg {
            stroke: var(--accent);
            fill: rgba(106, 90, 205, 0.2);
        }

        /* --- DRAWER (Tools overlay) --- */
        #tool-drawer {
            position: absolute;
            bottom: var(--toolbar-h);
            left: 0;
            width: 100%;
            height: auto;
            max-height: 50vh;
            background: rgba(20, 20, 35, 0.95);
            backdrop-filter: blur(20px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 40;
            overflow-y: auto;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #tool-drawer.open {
            transform: translateY(0);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .drawer-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .close-drawer {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
        }

        /* Tool Content Grid */
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .sticker {
            font-size: 2rem;
            cursor: pointer;
            text-align: center;
        }

        .color-row {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
        }

        .color-dot {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            flex-shrink: 0;
        }

        .color-dot.active {
            border-color: #fff;
            transform: scale(1.1);
        }

        .text-input-group {
            display: flex;
            gap: 10px;
        }

        #text-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 10px;
            border-radius: 8px;
            color: #fff;
        }

        /* --- DESKTOP VS MOBILE --- */
        @media (min-width: 769px) {
            #app {
                grid-template-columns: auto 1fr;
                grid-template-rows: auto 1fr;
            }

            header {
                grid-column: 1 / -1;
                /* Optional: Make header skinnier on desktop or integrate */
            }

            .mobile-nav {
                display: none;
            }

            .desktop-sidebar {
                display: flex;
                grid-row: 2;
                height: 100%;
            }

            #tool-drawer {
                width: 300px;
                left: 90px;
                top: 80px;
                bottom: auto;
                height: 500px;
                border-radius: 12px;
                transform: translateX(-150%);
                /* Slide left to hide */
            }

            #tool-drawer.open {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body>

    <div id="app">
        <!-- Header -->
        <header>
            <a href="booth.html" class="header-btn"><i data-lucide="arrow-left" width="16"></i> Back</a>
            <div style="font-family: 'Playfair Display'; font-size: 1.5rem; letter-spacing: -0.5px;">Edit</div>
            <button id="save-btn" class="header-btn finish-btn"><i data-lucide="download" width="16"></i>
                Finish</button>
        </header>

        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar">
            <button class="tool-btn" data-tool="stickers"><i data-lucide="smile" width="24"></i></button>
            <button class="tool-btn" data-tool="text"><i data-lucide="type" width="24"></i></button>
            <button class="tool-btn" data-tool="paint"><i data-lucide="brush" width="24"></i></button>
            <button class="tool-btn" data-tool="undo"><i data-lucide="undo-2" width="24"></i></button>
            <button class="tool-btn" data-tool="clear"><i data-lucide="trash-2" width="24"></i></button>
        </aside>

        <!-- Main Stage -->
        <main id="stage-container">
            <div class="canvas-wrapper">
                <canvas id="c"></canvas>
            </div>
        </main>

        <!-- Mobile Bottom Nav -->
        <nav class="mobile-nav">
            <button class="tool-btn" data-tool="stickers"><i data-lucide="smile"></i>Stickers</button>
            <button class="tool-btn" data-tool="text"><i data-lucide="type"></i>Text</button>
            <button class="tool-btn" data-tool="paint"><i data-lucide="brush"></i>Paint</button>
            <button class="tool-btn" data-tool="undo"><i data-lucide="undo-2"></i>Undo</button>
        </nav>

        <!-- Tool Drawer -->
        <section id="tool-drawer">
            <div class="drawer-header">
                <span class="drawer-title" id="drawer-title">Tools</span>
                <button class="close-drawer" id="close-drawer"><i data-lucide="x"></i></button>
            </div>

            <!-- STICKER CONTENT -->
            <div id="content-stickers" class="drawer-content" style="display:none;">
                <div class="sticker-grid">
                    <div class="sticker">‚ù§Ô∏è</div>
                    <div class="sticker">üòé</div>
                    <div class="sticker">üî•</div>
                    <div class="sticker">‚ú®</div>
                    <div class="sticker">üéÄ</div>
                    <div class="sticker">üì∏</div>
                    <div class="sticker">üê∂</div>
                    <div class="sticker">üëë</div>
                    <div class="sticker">üåà</div>
                    <div class="sticker">üçï</div>
                    <div class="sticker">üéâ</div>
                    <div class="sticker">üíÄ</div>
                    <div class="sticker">üëΩ</div>
                    <div class="sticker">üåü</div>
                    <div class="sticker">üí¨</div>
                </div>
            </div>

            <!-- TEXT CONTENT -->
            <div id="content-text" class="drawer-content" style="display:none;">
                <div class="text-input-group">
                    <input type="text" id="text-input" placeholder="Enter text..." value="Photo Time!">
                    <button class="header-btn finish-btn" id="add-text-btn">Add</button>
                </div>
                <div style="margin-top:15px; font-size:0.8rem; opacity:0.7;">Color</div>
                <div class="color-row">
                    <div class="color-dot active" style="background:#fff" data-color="#ffffff"></div>
                    <div class="color-dot" style="background:#000" data-color="#000000"></div>
                    <div class="color-dot" style="background:#FF6347" data-color="#FF6347"></div>
                    <div class="color-dot" style="background:#6A5ACD" data-color="#6A5ACD"></div>
                    <div class="color-dot" style="background:#FFD700" data-color="#FFD700"></div>
                    <div class="color-dot" style="background:#00CED1" data-color="#00CED1"></div>
                </div>
            </div>

            <!-- PAINT CONTENT -->
            <div id="content-paint" class="drawer-content" style="display:none;">
                <div class="color-row">
                    <div class="color-dot active" style="background:rgba(255,20,147,0.8)"
                        data-color="rgba(255,20,147,0.8)"></div>
                    <div class="color-dot" style="background:rgba(255,255,255,0.8)" data-color="rgba(255,255,255,0.8)">
                    </div>
                    <div class="color-dot" style="background:rgba(0,0,0,0.8)" data-color="rgba(0,0,0,0.8)"></div>
                    <div class="color-dot" style="background:rgba(100,255,100,0.8)" data-color="rgba(100,255,100,0.8)">
                    </div>
                    <div class="color-dot" style="background:rgba(0,191,255,0.8)" data-color="rgba(0,191,255,0.8)">
                    </div>
                </div>
                <div style="margin-top:15px; display:flex; justify-content:space-between;">
                    <button class="header-btn" id="clear-paint">Clear All Paint</button>
                    <button class="header-btn" id="stop-paint" style="border-color:red">Stop</button>
                </div>
            </div>

        </section>
    </div>

    <!-- Logic -->
    <script type="module">
        import { getLayoutConfig } from './layoutConfig.js';
        import { renderLayout } from './renderer.js';

        lucide.createIcons();

        // --- STATE ---
        const canvasEl = document.getElementById('c');
        let fabricCanvas;
        let layoutConfig;
        let photos = [];
        let activeColor = '#ffffff';

        // --- DOM ---
        const drawer = document.getElementById('tool-drawer');
        const drawerTitle = document.getElementById('drawer-title');
        const drawerContents = document.querySelectorAll('.drawer-content');
        const toolBtns = document.querySelectorAll('.tool-btn');
        const saveBtn = document.getElementById('save-btn');

        // --- INIT ---
        async function init() {
            // Load Data
            const layoutId = localStorage.getItem('selectedLayout');
            const photosJson = localStorage.getItem('capturedPhotos');

            if (!layoutId || !photosJson) {
                alert("No photos found. Redirecting to booth.");
                window.location.href = 'booth.html';
                return;
            }

            layoutConfig = getLayoutConfig(layoutId);
            photos = JSON.parse(photosJson);

            // 1. Generate Base Image (Static Layout)
            // We use an offscreen canvas to render the 'renderer.js' result
            const baseCanvas = document.createElement('canvas');
            baseCanvas.width = layoutConfig.width;
            baseCanvas.height = layoutConfig.height;
            const baseCtx = baseCanvas.getContext('2d');

            // Wait for render
            await new Promise(resolve => setTimeout(resolve, 0)); // tick
            try {
                // We need to support async image loading if renderer doesn't handle it fully synchronously
                // But renderer seems synchronous assuming images are loaded. 
                // Actually renderer takes 'photos' which are DataURLs.
                // However, creating Images is async. renderer.js handles 'img.onload' internally?
                // Let's modify renderer usage slightly or manually preload images here.
                // Looking at renderer.js code (from memory/view), it handles drawing img.src = src.
                // It draws immediately? No, it has `img.complete`.
                // We need to preload images first.
                await preloadImages(photos);

                renderLayout(baseCtx, layoutConfig, photos, { frameType: 'color' }); // Render base

            } catch (e) {
                console.error("Render fail", e);
            }

            // 2. Init Fabric
            // Scale logic: Fit canvas to screen
            const container = document.getElementById('stage-container');
            const padding = 40;
            const availW = container.clientWidth - padding;
            const availH = container.clientHeight - padding;

            const scale = Math.min(availW / layoutConfig.width, availH / layoutConfig.height);

            fabricCanvas = new fabric.Canvas('c', {
                width: layoutConfig.width * scale,
                height: layoutConfig.height * scale,
                selection: true
            });

            // Set Background
            // We need to wait for renderer.js images to actually load. 
            // Since renderer.js might run asynchronously for images, let's just stick the photos in directly first.
            // Actually, let's trust the preloader.

            // Convert baseCanvas to URL
            const bgUrl = baseCanvas.toDataURL('image/jpeg', 0.9);

            fabric.Image.fromURL(bgUrl, function (img) {
                img.set({
                    originX: 'left',
                    originY: 'top',
                    scaleX: scale,
                    scaleY: scale
                });
                fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas));
            });

            // Store Scale for export reference
            fabricCanvas.originalWidth = layoutConfig.width;
            fabricCanvas.originalHeight = layoutConfig.height;
            fabricCanvas.viewScale = scale;

            // Handle Resize
            window.addEventListener('resize', () => {
                // ideally re-scale, but simple reload is cleaner for MVP
                // location.reload();
            });
        }

        // Helper: Preload images for synchronous canvas drawing
        function preloadImages(srcArray) {
            return Promise.all(srcArray.map(src => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = resolve;
                    img.onerror = resolve; // proceed anyway
                    img.src = src;
                });
            }));
        }

        // --- TOOLS ---

        function openDrawer(toolName) {
            // Reset
            fabricCanvas.isDrawingMode = false;

            // UI
            drawer.classList.add('open');
            drawerContents.forEach(el => el.style.display = 'none');

            if (toolName === 'stickers') {
                drawerTitle.textContent = "Stickers";
                document.getElementById('content-stickers').style.display = 'block';
            } else if (toolName === 'text') {
                drawerTitle.textContent = "Add Text";
                document.getElementById('content-text').style.display = 'block';
            } else if (toolName === 'paint') {
                drawerTitle.textContent = "Paint Mode";
                document.getElementById('content-paint').style.display = 'block';
                // Activate Paint
                fabricCanvas.isDrawingMode = true;
                fabricCanvas.freeDrawingBrush.width = 10;
                fabricCanvas.freeDrawingBrush.color = activeColor;
            }
        }

        function closeDrawer() {
            drawer.classList.remove('open');
            fabricCanvas.isDrawingMode = false;
        }

        // Listeners
        document.getElementById('close-drawer').onclick = closeDrawer;

        toolBtns.forEach(btn => {
            btn.onclick = () => {
                const tool = btn.dataset.tool;
                if (tool === 'undo') {
                    // Simple undo: remove last object
                    const objects = fabricCanvas.getObjects();
                    if (objects.length > 0) fabricCanvas.remove(objects[objects.length - 1]);
                } else if (tool === 'clear') {
                    // Clear all objects (not background)
                    fabricCanvas.clear();
                    // Re-render BG - Wait, clear removes BG? Yes often. 
                    // Actually better logic:
                    const obs = fabricCanvas.getObjects();
                    obs.forEach(o => fabricCanvas.remove(o));
                    // fabricCanvas.setBackgroundImage... persists usually
                } else {
                    openDrawer(tool);
                }
            };
        });

        // Stickers
        document.querySelectorAll('.sticker').forEach(el => {
            el.onclick = () => {
                const text = new fabric.Text(el.textContent, {
                    left: fabricCanvas.width / 2,
                    top: fabricCanvas.height / 2,
                    fontSize: 80 * fabricCanvas.viewScale,
                    originX: 'center', originY: 'center',
                    selectable: true
                });
                fabricCanvas.add(text);
                closeDrawer();
            };
        });

        // Text
        document.getElementById('add-text-btn').onclick = () => {
            const val = document.getElementById('text-input').value;
            if (!val) return;
            const text = new fabric.IText(val, {
                left: fabricCanvas.width / 2,
                top: fabricCanvas.height / 2,
                fontFamily: 'DM Sans',
                fontSize: 60 * fabricCanvas.viewScale,
                fill: activeColor,
                fontWeight: 'bold',
                originX: 'center', originY: 'center',
                shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 10, offsetX: 2, offsetY: 2 })
            });
            fabricCanvas.add(text);
            fabricCanvas.setActiveObject(text);
            closeDrawer();
        };

        // Colors
        document.querySelectorAll('.color-dot').forEach(el => {
            el.onclick = () => {
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
                activeColor = el.dataset.color;

                // Update live paint
                if (fabricCanvas.isDrawingMode) fabricCanvas.freeDrawingBrush.color = activeColor;

                // Update active object if text
                const activeObj = fabricCanvas.getActiveObject();
                if (activeObj && (activeObj.type === 'i-text' || activeObj.type === 'text')) {
                    activeObj.set('fill', activeColor);
                    fabricCanvas.renderAll();
                }
            };
        });

        // Stop Paint
        document.getElementById('stop-paint').onclick = closeDrawer;
        document.getElementById('clear-paint').onclick = () => {
            const obs = fabricCanvas.getObjects();
            obs.forEach(o => {
                if (o.type === 'path') fabricCanvas.remove(o);
            });
        }

        // SAVE
        saveBtn.onclick = () => {
            // High Res Export
            // 1. Create a multiplier to get back to original layout size
            const multiplier = layoutConfig.width / fabricCanvas.width;

            const dataURL = fabricCanvas.toDataURL({
                format: 'png',
                quality: 1.0,
                multiplier: multiplier
            });

            // Download logic
            const link = document.createElement('a');
            link.download = `photo-time-${Date.now()}.png`;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Redirect home
            setTimeout(() => window.location.href = '../index.html', 1000);
        };

        // RUN
        window.addEventListener('load', init);

    </script>
</body>

</html>