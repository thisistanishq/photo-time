<!DOCTYPE html>
<html lang="en">
<head>
    

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- SECURITY HARDENING -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: blob: https:; font-src 'self' data: https:;">
    <script src="security.js"></script>

    <title>Photo Time | Studio Editor</title>

    <style>
        /* GLOBAL SECURITY CSS */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
        }
    </style>

    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;700;800&family=Outfit:wght@300;500;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
        /* --- STUDIO VARIABLES --- */
        :root {
            --bg-light: #1565C0;
            /* Deep Blue Background */
            --text-dark: #FFFFFF;
            /* White Text */
            --glass: rgba(255, 255, 255, 0.15);
            /* Glass on Dark */
            --glass-strong: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.2);
            --primary: #fff;
            /* Primary buttons white on blue */
            --accent: #64B5F6;
            --radius-md: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- AURORA BACKGROUND (Shared) --- */
        .aurora-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0D47A1, #1565C0, #1976D2);
            /* Blue Gradient */
            overflow: hidden;
        }

        .aurora-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            /* Slightly less blur for definition */
            opacity: 0.4;
            animation: float 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }

        .blob-1 {
            top: -10%;
            left: -10%;
            width: 50vw;
            height: 50vw;
            background: #42A5F5;
            /* Lighter Blue */
        }

        .blob-2 {
            bottom: -20%;
            right: -10%;
            width: 60vw;
            height: 60vw;
            background: #039BE5;
            /* Deep Sky Blue */
            animation-delay: -5s;
        }

        .blob-3 {
            top: 40%;
            left: 40%;
            width: 40vw;
            height: 40vw;
            background: #64B5F6;
            /* Accent Blue */
            animation-delay: -10s;
        }

        @keyframes float {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(40px, 60px) scale(1.1);
            }
        }

        /* --- UI LAYOUT --- */
        #studio-layout {
            display: grid;
            grid-template-columns: 80px 1fr 340px;
            grid-template-rows: 60px 1fr;
            height: 100%;
            width: 100%;
        }

        /* --- HEADER --- */
        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            background: rgba(0, 0, 0, 0.3);
            /* Dark glass for white icons */
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
        }

        .brand {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: -0.5px;
            color: var(--text-dark);
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .btn-ghost {
            background: #1565C0;
            /* Default Deep Blue */
            color: #fff;
            border: 1px solid #1565C0;
        }

        .btn-ghost:hover {
            background: #fff;
            /* White on Hover */
            color: #1565C0;
            border-color: #1565C0;
        }

        .btn-icon-only {
            padding: 10px;
            width: 40px;
            height: 40px;
            justify-content: center;
        }

        .btn-primary {
            background: #1565C0;
            /* Default Deep Blue */
            color: #fff;
            border: 1px solid #1565C0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: #fff;
            /* White on Hover */
            color: #1565C0;
            border-color: #1565C0;
        }

        .btn:hover {
            opacity: 1;
            /* Disable opacity fade for solid color swap */
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #ccc !important;
            color: #666 !important;
            border-color: #ccc !important;
        }

        /* --- TOOLBAR --- */
        .toolbar {
            grid-column: 1;
            grid-row: 2;
            background: #fff;
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            gap: 16px;
            z-index: 90;
            overflow-y: auto;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid transparent;
            color: #999;
            cursor: pointer;
            transition: 0.2s;
        }

        .tool-btn i {
            width: 20px;
            height: 20px;
        }

        .tool-btn span {
            font-size: 0.6rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .tool-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .tool-btn.active {
            background: #1565C0;
            /* Deep Blue Active */
            color: #fff;
        }

        /* --- STAGE --- */
        .stage {
            grid-column: 2;
            grid-row: 2;
            background: transparent;
            /* Show Aurora */
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #canvas-wrapper {
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
            transform-origin: center center;
            display: inline-block;
            background: #fff;
            /* Paper backing */
        }

        /* --- PROPERTIES PANEL --- */
        .properties-panel {
            grid-column: 3;
            grid-row: 2;
            background: #fff;
            border-left: 1px solid var(--glass-border);
            padding: 0;
            overflow-y: auto;
            z-index: 90;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 16px;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .panel-content {
            padding: 0 24px 100px 24px;
        }

        .control-group {
            margin-bottom: 24px;
        }

        .control-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.5;
            margin-bottom: 10px;
        }

        /* --- TABS & GRIDS --- */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 6px 12px;
            background: #1565C0;
            /* Default Deep Blue */
            color: #fff;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #1565C0;
        }

        .tab:hover,
        .tab.active {
            background: #fff;
            /* White on Hover/Active */
            color: #1565C0;
            /* Blue Text */
            border-color: #1565C0;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .item-box {
            aspect-ratio: 1;
            background: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            border: 1px solid #eee;
            transition: all 0.1s;
        }

        .item-box:hover {
            background: #fafafa;
            border-color: #1565C0;
        }

        .filter-btn {
            padding: 12px;
            background: #1565C0;
            /* Default Deep Blue */
            color: #fff;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid #1565C0;
            cursor: pointer;
            transition: 0.2s;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #fff;
            /* White on Hover/Active */
            color: #1565C0;
            /* Blue Text */
            border-color: #1565C0;
        }

        /* Color & Brush Inputs */
        input[type="color"] {
            -webkit-appearance: none;
            border: 1px solid #eee;
            width: 100%;
            height: 40px;
            border-radius: 6px;
            padding: 0;
            overflow: hidden;
            cursor: pointer;
            background: #fff;
        }

        input[type="range"] {
            width: 100%;
            accent-color: #1565C0;
            /* Deep Blue Theme */
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
            background: #fff;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        /* --- RESPONSIVE REDESIGN (Complete Overhaul) --- */
        @media (max-width: 900px) {

            /* 1. Layout: Vertical Stack */
            #studio-layout {
                display: flex;
                flex-direction: column;
                height: 100vh;
                width: 100vw;
                overflow: hidden;
                position: relative;
            }

            /* 2. Header: Compact & Top */
            header {
                flex: 0 0 60px;
                padding: 0 16px;
                justify-content: space-between;
                background: rgba(21, 101, 192, 0.95);
                /* Deep Blue for visibility */
                z-index: 200;
            }

            .brand {
                display: none;
            }

            .hide-mobile {
                display: none;
            }

            /* Mobile doesn't need brand text saving space */
            .header-controls {
                width: 100%;
                justify-content: space-between;
                gap: 2px;
                /* Tighter gap */
            }

            .header-controls .btn {
                padding: 8px 8px;
                /* Tighter padding */
                font-size: 0.75rem;
                /* Slightly smaller text */
            }

            .btn-icon-only {
                width: 36px;
                height: 36px;
                padding: 0;
            }

            /* 3. Stage: Maximize Space */
            .stage {
                flex: 1;
                /* Takes all remaining space */
                width: 100%;
                background: transparent;
                display: flex;
                align-items: center;
                justify-content: center;
                padding-bottom: 80px;
                /* Space for toolbar */
                z-index: 50;
            }

            /* 4. Toolbar: Fixed Bottom Bar */
            .toolbar {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 70px;
                flex-direction: row;
                justify-content: space-evenly;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-right: none;
                border-top: 1px solid rgba(0, 0, 0, 0.05);
                padding: 0;
                gap: 0;
                z-index: 150;
            }

            .tool-btn {
                width: 100%;
                height: 100%;
                border-radius: 0;
                background: transparent;
            }

            .tool-btn.active {
                border-top: 3px solid #1565C0;
                /* Deep Blue Accent */
                background: rgba(21, 101, 192, 0.05);
                /* Blue Tint */
                color: #1565C0;
            }

            /* 5. Properties Panel: Slide-Up Bottom Sheet */
            .properties-panel {
                position: absolute;
                bottom: 70px;
                /* Above toolbar */
                left: 0;
                width: 100%;
                height: 40vh;
                /* Reduced from 50vh */
                max-height: 320px;
                /* Limit height */
                background: #fff;
                border-left: none;
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
                transform: translateY(110%);
                /* Hidden by default */
                transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                z-index: 100;
                display: flex;
                flex-direction: column;
            }

            .properties-panel.open {
                transform: translateY(0);
            }

            /* Shift stage when panel is open to keep canvas visible */
            body.panel-active .stage {
                padding-bottom: 0;
                transition: padding 0.3s;
            }

            /* Compact Styles for Panel Content */
            .grid-2 {
                gap: 8px;
            }

            .filter-btn {
                padding: 8px;
                font-size: 0.75rem;
            }

            .control-group {
                margin-bottom: 16px;
            }

            .btn-primary {
                padding: 8px 16px;
                font-size: 0.8rem;
            }

            input[type="range"] {
                height: 4px;
            }

            /* Smaller Font Preview */
            .filter-btn[style*="font-family"] {
                font-size: 1rem !important;
                padding: 10px;
            }

            /* Add a "Handle" to look like a sheet */
            .panel-header {
                padding: 12px;
                display: flex;
                justify-content: center;
                border-bottom: 1px solid #eee;
            }

            .panel-header::before {
                content: '';
                width: 40px;
                height: 4px;
                background: #ddd;
                border-radius: 2px;
                display: block;
            }

            .panel-header h2 {
                display: none;
            }

            /* Hide title, reliance on context */

            .panel-content {
                overflow-y: auto;
                padding: 20px;
                padding-bottom: 40px;
            }

            .panel-toggle {
                display: none;
            }

            /* Not needed */
        }
    </style>



    <style>body { visibility: hidden; opacity: 0; }</style> <!-- Hide until loaded -->
</head>
<body>
    <script>
        (function() {
            var e = "CgogICAgPGRpdiBjbGFzcz0iYXVyb3JhLWJnIj4KICAgICAgICA8ZGl2IGNsYXNzPSJhdXJvcmEtYmxvYiBibG9iLTEiPjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImF1cm9yYS1ibG9iIGJsb2ItMiI+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iYXVyb3JhLWJsb2IgYmxvYi0zIj48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBpZD0ic3R1ZGlvLWxheW91dCI+CiAgICAgICAgPGhlYWRlcj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iYnJhbmQiPlN0dWRpbyBFZGl0b3I8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iaGVhZGVyLWNvbnRyb2xzIj4KICAgICAgICAgICAgICAgIDwhLS0gVW5kbyAvIFJlZG8gLS0+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLWdob3N0IGJ0bi1pY29uLW9ubHkiIG9uY2xpY2s9InVuZG8oKSIgaWQ9InVuZG8tYnRuIiB0aXRsZT0iVW5kbyI+PGkKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS1sdWNpZGU9InVuZG8tMiI+PC9pPjwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1naG9zdCBidG4taWNvbi1vbmx5IiBvbmNsaWNrPSJyZWRvKCkiIGlkPSJyZWRvLWJ0biIgdGl0bGU9IlJlZG8iPjxpCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEtbHVjaWRlPSJyZWRvLTIiPjwvaT48L2J1dHRvbj4KCiAgICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0ib3BhY2l0eTowLjI7IGNvbG9yOiBncmV5OyI+fDwvc3Bhbj4KCiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLWdob3N0IiBvbmNsaWNrPSJ3aW5kb3cubG9jYXRpb24uaHJlZj0nYm9vdGguaHRtbCciPjxpIGRhdGEtbHVjaWRlPSJhcnJvdy1sZWZ0IgogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT0id2lkdGg6MTZweCI+PC9pPiBCYWNrPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLWdob3N0IiBvbmNsaWNrPSJ3aW5kb3cubG9jYXRpb24uaHJlZj0nbGF5b3V0Lmh0bWwnIj48aSBkYXRhLWx1Y2lkZT0ibGF5b3V0LWdyaWQiCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlPSJ3aWR0aDoxNnB4Ij48L2k+IDxzcGFuIGNsYXNzPSJoaWRlLW1vYmlsZSI+Q2hhbmdlIDwvc3Bhbj5MYXlvdXQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgb25jbGljaz0icHJpbnRQaG90bygpIj48aSBkYXRhLWx1Y2lkZT0icHJpbnRlciI+PC9pPiBQcmludDwvYnV0dG9uPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2hlYWRlcj4KICAgICAgICA8ZGl2IGNsYXNzPSJ0b29sYmFyIj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idG9vbC1idG4gYWN0aXZlIiBkYXRhLWlkPSJzdGlja2VycyI+PGkKICAgICAgICAgICAgICAgICAgICBkYXRhLWx1Y2lkZT0ic3RpY2tlciI+PC9pPjxzcGFuPlN0aWNrZXJzPC9zcGFuPjwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ0b29sLWJ0biIgZGF0YS1pZD0idGV4dCI+PGkgZGF0YS1sdWNpZGU9InR5cGUiPjwvaT48c3Bhbj5UZXh0PC9zcGFuPjwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ0b29sLWJ0biIgZGF0YS1pZD0iZHJhdyI+PGkgZGF0YS1sdWNpZGU9InBlbmNpbCI+PC9pPjxzcGFuPkRyYXc8L3NwYW4+PC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InRvb2wtYnRuIiBkYXRhLWlkPSJmaWx0ZXJzIj48aSBkYXRhLWx1Y2lkZT0ic2Nhbi1saW5lIj48L2k+PHNwYW4+RWRpdDwvc3Bhbj48L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idG9vbC1idG4iIGRhdGEtaWQ9ImJhY2tncm91bmQiPjxpIGRhdGEtbHVjaWRlPSJwYWxldHRlIj48L2k+PHNwYW4+Qkc8L3NwYW4+PC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InRvb2wtYnRuIiBkYXRhLWlkPSJtYWdpYyI+PGkgZGF0YS1sdWNpZGU9IndhbmQtMiI+PC9pPjxzcGFuPk1hZ2ljPC9zcGFuPjwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InN0YWdlIiBpZD0ic3RhZ2UiPgogICAgICAgICAgICA8ZGl2IGlkPSJjYW52YXMtd3JhcHBlciI+PGNhbnZhcyBpZD0iYyI+PC9jYW52YXM+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icGFuZWwtdG9nZ2xlIiBvbmNsaWNrPSJkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFuZWwnKS5jbGFzc0xpc3QudG9nZ2xlKCdvcGVuJykiPjxpCiAgICAgICAgICAgICAgICBkYXRhLWx1Y2lkZT0ic2xpZGVycy1ob3Jpem9udGFsIj48L2k+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0icHJvcGVydGllcy1wYW5lbCIgaWQ9InBhbmVsIj48L2Rpdj4KICAgIDwvZGl2PgogICAgPHNjcmlwdCB0eXBlPSJtb2R1bGUiPgogICAgICAgIGlmICh3aW5kb3cuc2VsZiA9PT0gd2luZG93LnRvcCkgewogICAgICAgICAgICBhbGVydCgiVGhpcyBlZGl0b3IgbXVzdCBydW4gaW5zaWRlIHRoZSBib290aC4iKTsKICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9ICJsYXlvdXQuaHRtbCI7CiAgICAgICAgfQoKICAgICAgICBpbXBvcnQgeyBnZXRMYXlvdXRDb25maWcsIExBWU9VVFMgfSBmcm9tICcuL2xheW91dENvbmZpZy5qcyc7CgogICAgICAgIGNvbnN0IFNUSUNLRVJTID0gewogICAgICAgICAgICAiVmliZXMiOiBbIuKcqCIsICLwn5KWIiwgIvCflKUiLCAi8J+SgCIsICLwn6aLIiwgIvCfkYAiLCAi8J+ShSIsICLwn5KOIiwgIvCfkbsiLCAi4pqhIiwgIvCfja0iLCAi8J+OqCIsICLwn4yfIiwgIvCfjJkiLCAi8J+OtSIsICLimIHvuI8iXSwKICAgICAgICAgICAgIkN5YmVyIjogWyLwn5G+IiwgIvCfpJYiLCAi8J+SvyIsICLwn5SLIiwgIvCfkrsiLCAi8J+ToSIsICLwn5W577iPIiwgIvCfkr0iLCAi8J+TnyIsICLwn5ax77iPIiwgIuKame+4jyIsICLwn6esIiwgIvCfp6oiLCAi8J+UrSIsICLwn4yMIiwgIvCfm7giXSwKICAgICAgICAgICAgIkRlY29yIjogWyLwn46AIiwgIvCfjogiLCAi8J+OgSIsICLwn46QIiwgIvCfjosiLCAi8J+OiiIsICLwn6qFIiwgIvCfqrQiLCAi8J+NhCIsICLwn4y6IiwgIvCfjLgiLCAi8J+SriIsICLwn4+177iPIiwgIvCfposiLCAi8J+QiCIsICLwn5CaIl0sCiAgICAgICAgICAgICJHcmFkaWVudCI6IFsi8J+UtCIsICLwn5+gIiwgIvCfn6EiLCAi8J+foiIsICLwn5S1IiwgIvCfn6MiLCAi4pqrIiwgIuKaqiIsICLwn5+kIiwgIvCfn6UiLCAi8J+fpyIsICLwn5+oIiwgIvCfn6kiLCAi8J+fpiIsICLwn5+qIiwgIuKsmyJdLAogICAgICAgICAgICAiTG92ZSI6IFsi4p2k77iPIiwgIvCfp6EiLCAi8J+SmyIsICLwn5KaIiwgIvCfkpkiLCAi8J+SnCIsICLwn5akIiwgIvCfpI0iLCAi8J+SjCIsICLwn5KLIiwgIvCfko0iLCAi8J+SkCIsICLwn5KPIiwgIvCfkpEiLCAi4p2j77iPIiwgIvCfkpUiXSwKICAgICAgICAgICAgIlN1bW1lciI6IFsi8J+MuCIsICLwn4y8IiwgIvCfjLsiLCAi4piA77iPIiwgIvCfjJkiLCAi4q2QIiwgIuKdhO+4jyIsICLwn4yKIiwgIvCfjLQiLCAi8J+MtSIsICLwn42EIiwgIvCfjYAiLCAi8J+RmSIsICLwn5W277iPIiwgIvCfjaYiLCAi8J+NuSJdLAogICAgICAgICAgICAiRm9vZCI6IFsi8J+NlSIsICLwn42UIiwgIvCfjZ8iLCAi8J+MrSIsICLwn42/IiwgIvCfpZ4iLCAi8J+lkCIsICLwn6WoIiwgIvCfpa8iLCAi8J+lliIsICLwn6eAIiwgIvCfpZciLCAi8J+NoyIsICLwn42xIiwgIvCfpZ8iLCAi8J+NpCJdLAogICAgICAgICAgICAiV29yZHMiOiBbIkxPTCIsICJPTUciLCAiWU9MTyIsICJXT1ciLCAiSEVZIiwgIkJZRSIsICJTVVAiLCAiTk9QRSIsICJZRUFIIiwgIk9LIiwgIlNMQVkiLCAiTElUIiwgIkJFVCIsICJWSUJFIiwgIk1PT0QiLCAiQlJVSCJdCiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgUEFUVEVSTlMgPSBbCiAgICAgICAgICAgIHsgbmFtZTogJ0RvdHMnLCBkcmF3OiAoY3R4LCB3LCBoKSA9PiB7IGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLDAsMCwwLjEpJzsgY3R4LmJlZ2luUGF0aCgpOyBjdHguYXJjKHcgLyAyLCBoIC8gMiwgMiwgMCwgNi4yOCk7IGN0eC5maWxsKCk7IH0gfSwKICAgICAgICAgICAgeyBuYW1lOiAnU3RyaXBlcycsIGRyYXc6IChjdHgsIHcsIGgpID0+IHsgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC4xKSc7IGN0eC5saW5lV2lkdGggPSAyOyBjdHguYmVnaW5QYXRoKCk7IGN0eC5tb3ZlVG8oMCwgMCk7IGN0eC5saW5lVG8odywgaCk7IGN0eC5zdHJva2UoKTsgfSB9LAogICAgICAgICAgICB7IG5hbWU6ICdHcmlkJywgZHJhdzogKGN0eCwgdywgaCkgPT4geyBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgwLDAsMCwwLjEpJzsgY3R4LnN0cm9rZVJlY3QoMCwgMCwgdywgaCk7IH0gfSwKICAgICAgICAgICAgeyBuYW1lOiAnQ2hlY2snLCBkcmF3OiAoY3R4LCB3LCBoKSA9PiB7IGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLDAsMCwwLjA1KSc7IGN0eC5maWxsUmVjdCgwLCAwLCB3IC8gMiwgaCAvIDIpOyBjdHguZmlsbFJlY3QodyAvIDIsIGggLyAyLCB3IC8gMiwgaCAvIDIpOyB9IH0KICAgICAgICBdOwoKICAgICAgICBsZXQgY2FudmFzLCBhY3RpdmVPYmplY3QsIGN1cnJlbnRMYXlvdXRJZCA9ICcnLCBjdXJyZW50QmdDb2xvciA9ICcjZmZmZmZmJywgY3VycmVudFBhdHRlcm4gPSBudWxsOwoKICAgICAgICAvLyAtLS0gSElTVE9SWSBTVEFURSAtLS0KICAgICAgICBsZXQgaGlzdG9yeSA9IFtdOwogICAgICAgIGxldCBoaXN0b3J5UHJvY2Vzc2luZyA9IGZhbHNlOwogICAgICAgIGxldCBoaXN0b3J5U3RlcCA9IC0xOwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGFzeW5jICgpID0+IHsKICAgICAgICAgICAgbHVjaWRlLmNyZWF0ZUljb25zKCk7CiAgICAgICAgICAgIGluaXRDYW52YXMoKTsKICAgICAgICAgICAgYXdhaXQgbG9hZFByb2plY3QoKTsKICAgICAgICAgICAgc2V0dXBUb29sYmFyKCk7CiAgICAgICAgICAgIHJlbmRlclBhbmVsKCdzdGlja2VycycpOwoKICAgICAgICAgICAgLy8gR2xvYmFsIENsaWNrIE91dHNpZGUgTGlzdGVuZXIKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgcGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFuZWwnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzUGFuZWxPcGVuID0gcGFuZWwuY2xhc3NMaXN0LmNvbnRhaW5zKCdvcGVuJyk7CgogICAgICAgICAgICAgICAgLy8gSWYgY2xpY2tlZCBpbnNpZGUgcGFuZWwgb3Igb24gYSB0b29sYmFyIGJ1dHRvbiwgZG8gbm90aGluZwogICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJy5wcm9wZXJ0aWVzLXBhbmVsJykgfHwgZS50YXJnZXQuY2xvc2VzdCgnLnRvb2wtYnRuJykpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBJZiBwYW5lbCBpcyBvcGVuIGFuZCBjbGljayBpcyBvdXRzaWRlLCBjbG9zZSBpdAogICAgICAgICAgICAgICAgaWYgKGlzUGFuZWxPcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgcGFuZWwuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicpOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgncGFuZWwtYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRvb2wtYnRuJykuZm9yRWFjaChiID0+IGIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJykpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVzaXplV3JhcHBlciwgMzAwKTsgLy8gUmVzZXQgc21vb3RoIHJlc2l6ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgZnVuY3Rpb24gaW5pdENhbnZhcygpIHsKICAgICAgICAgICAgY2FudmFzID0gbmV3IGZhYnJpYy5DYW52YXMoJ2MnLCB7IGJhY2tncm91bmRDb2xvcjogJyNmZmZmZmYnLCBwcmVzZXJ2ZU9iamVjdFN0YWNraW5nOiB0cnVlLCBzZWxlY3Rpb246IHRydWUgfSk7CiAgICAgICAgICAgIGZhYnJpYy5PYmplY3QucHJvdG90eXBlLnRyYW5zcGFyZW50Q29ybmVycyA9IGZhbHNlOwogICAgICAgICAgICBmYWJyaWMuT2JqZWN0LnByb3RvdHlwZS5jb3JuZXJDb2xvciA9ICcjZmZmZmZmJzsKICAgICAgICAgICAgZmFicmljLk9iamVjdC5wcm90b3R5cGUuY29ybmVyU3Ryb2tlQ29sb3IgPSAnIzE1NjVDMCc7IC8qIERlZXAgQmx1ZSAqLwogICAgICAgICAgICBmYWJyaWMuT2JqZWN0LnByb3RvdHlwZS5ib3JkZXJDb2xvciA9ICcjMTU2NUMwJzsgLyogRGVlcCBCbHVlICovCiAgICAgICAgICAgIGZhYnJpYy5PYmplY3QucHJvdG90eXBlLmNvcm5lclNpemUgPSA4OwogICAgICAgICAgICBmYWJyaWMuT2JqZWN0LnByb3RvdHlwZS5wYWRkaW5nID0gNDsKCiAgICAgICAgICAgIGNhbnZhcy5vbignc2VsZWN0aW9uOmNyZWF0ZWQnLCAoZSkgPT4gdXBkYXRlU2VsZWN0aW9uKGUuc2VsZWN0ZWRbMF0pKTsKICAgICAgICAgICAgY2FudmFzLm9uKCdzZWxlY3Rpb246dXBkYXRlZCcsIChlKSA9PiB1cGRhdGVTZWxlY3Rpb24oZS5zZWxlY3RlZFswXSkpOwogICAgICAgICAgICBjYW52YXMub24oJ3NlbGVjdGlvbjpjbGVhcmVkJywgKCkgPT4gdXBkYXRlU2VsZWN0aW9uKG51bGwpKTsKCiAgICAgICAgICAgIC8vIEhpc3RvcnkgSG9va3MKICAgICAgICAgICAgY2FudmFzLm9uKCdvYmplY3Q6YWRkZWQnLCAoKSA9PiBzYXZlSGlzdG9yeSgpKTsKICAgICAgICAgICAgY2FudmFzLm9uKCdvYmplY3Q6bW9kaWZpZWQnLCAoKSA9PiBzYXZlSGlzdG9yeSgpKTsKICAgICAgICAgICAgY2FudmFzLm9uKCdvYmplY3Q6cmVtb3ZlZCcsICgpID0+IHNhdmVIaXN0b3J5KCkpOwogICAgICAgIH0KCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gbG9hZFByb2plY3QoKSB7CiAgICAgICAgICAgIGNvbnN0IHN0b3JlZFBob3RvcyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdjYXB0dXJlZFBob3RvcycpOyBpZiAoIXN0b3JlZFBob3RvcykgeyBhbGVydCgiTm8gcGhvdG9zIGZvdW5kISIpOyByZXR1cm47IH0gY29uc3QgcGhvdG9zID0gSlNPTi5wYXJzZShzdG9yZWRQaG90b3MpOwogICAgICAgICAgICBjb25zdCBsYXlvdXRJZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzZWxlY3RlZExheW91dCcpIHx8ICdjbGFzc2ljX3doaXRlJzsgY3VycmVudExheW91dElkID0gbGF5b3V0SWQ7IGxldCBsYXlvdXQgPSBnZXRMYXlvdXRDb25maWcobGF5b3V0SWQpIHx8IGdldExheW91dENvbmZpZygnY2xhc3NpY193aGl0ZScpOwogICAgICAgICAgICBjYW52YXMuc2V0V2lkdGgobGF5b3V0LndpZHRoKTsgY2FudmFzLnNldEhlaWdodChsYXlvdXQuaGVpZ2h0KTsgY3VycmVudEJnQ29sb3IgPSBsYXlvdXQuYmFja2dyb3VuZENvbG9yIHx8ICcjZmZmZmZmJzsgY2FudmFzLmJhY2tncm91bmRDb2xvciA9IGN1cnJlbnRCZ0NvbG9yOwogICAgICAgICAgICBjb25zdCBsb2FkSW1hZ2UgPSAoc3JjKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4geyBjb25zdCBpc0RhdGEgPSBzcmMuc3RhcnRzV2l0aCgnZGF0YTonKTsgZmFicmljLkltYWdlLmZyb21VUkwoc3JjLCBpbWcgPT4gcmVzb2x2ZShpbWcpLCBpc0RhdGEgPyB1bmRlZmluZWQgOiB7IGNyb3NzT3JpZ2luOiAnYW5vbnltb3VzJyB9KTsgfSk7CiAgICAgICAgICAgIGNvbnN0IHNsb3RzID0gbGF5b3V0LnNsb3RzIHx8IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKHNsb3RzLmxlbmd0aCwgcGhvdG9zLmxlbmd0aCk7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3Qgc2xvdCA9IHNsb3RzW2ldOyBjb25zdCBpbWcgPSBhd2FpdCBsb2FkSW1hZ2UocGhvdG9zW2ldKTsgaWYgKCFpbWcpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29uc3Qgc2xvdFcgPSBzbG90LncgKiBsYXlvdXQud2lkdGg7IGNvbnN0IHNsb3RIID0gc2xvdC5oICogbGF5b3V0LmhlaWdodDsgY29uc3Qgc2xvdFggPSBzbG90LnggKiBsYXlvdXQud2lkdGg7IGNvbnN0IHNsb3RZID0gc2xvdC55ICogbGF5b3V0LmhlaWdodDsKICAgICAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gTWF0aC5tYXgoc2xvdFcgLyBpbWcud2lkdGgsIHNsb3RIIC8gaW1nLmhlaWdodCk7IGltZy5zY2FsZShzY2FsZSk7CiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZWRXID0gaW1nLndpZHRoICogc2NhbGU7IGNvbnN0IHNjYWxlZEggPSBpbWcuaGVpZ2h0ICogc2NhbGU7IGNvbnN0IG9mZnNldFggPSAoc2NhbGVkVyAtIHNsb3RXKSAvIDI7IGNvbnN0IG9mZnNldFkgPSAoc2NhbGVkSCAtIHNsb3RIKSAvIDI7CiAgICAgICAgICAgICAgICBpbWcuc2V0KHsgbGVmdDogc2xvdFggLSBvZmZzZXRYLCB0b3A6IHNsb3RZIC0gb2Zmc2V0WSwgc2VsZWN0YWJsZTogdHJ1ZSwgZGF0YTogeyB0eXBlOiAncGhvdG8nIH0gfSk7CiAgICAgICAgICAgICAgICBpbWcuZGF0YS5zbG90UmVjdCA9IHsgbGVmdDogc2xvdFgsIHRvcDogc2xvdFksIHdpZHRoOiBzbG90VywgaGVpZ2h0OiBzbG90SCB9OwogICAgICAgICAgICAgICAgY29uc3QgY2xpcCA9IG5ldyBmYWJyaWMuUmVjdCh7IGxlZnQ6IHNsb3RYLCB0b3A6IHNsb3RZLCB3aWR0aDogc2xvdFcsIGhlaWdodDogc2xvdEgsIGFic29sdXRlUG9zaXRpb25lZDogdHJ1ZSwgcng6IGxheW91dC5zbG90UmFkaXVzIHx8IDAsIHJ5OiBsYXlvdXQuc2xvdFJhZGl1cyB8fCAwIH0pOwogICAgICAgICAgICAgICAgaW1nLmNsaXBQYXRoID0gY2xpcDsKICAgICAgICAgICAgICAgIGNhbnZhcy5hZGQoaW1nKTsKICAgICAgICAgICAgICAgIGlmIChsYXlvdXQuc2xvdEJvcmRlcldpZHRoKSB7IGNvbnN0IGZyYW1lID0gbmV3IGZhYnJpYy5SZWN0KHsgbGVmdDogc2xvdFgsIHRvcDogc2xvdFksIHdpZHRoOiBzbG90VywgaGVpZ2h0OiBzbG90SCwgZmlsbDogJ3RyYW5zcGFyZW50Jywgc3Ryb2tlOiBsYXlvdXQuc2xvdEJvcmRlckNvbG9yIHx8ICcjZmZmJywgc3Ryb2tlV2lkdGg6IGxheW91dC5zbG90Qm9yZGVyV2lkdGgsIHJ4OiBsYXlvdXQuc2xvdFJhZGl1cyB8fCAwLCByeTogbGF5b3V0LnNsb3RSYWRpdXMgfHwgMCwgc2VsZWN0YWJsZTogZmFsc2UsIGV2ZW50ZWQ6IGZhbHNlIH0pOyBpZiAobGF5b3V0LnNsb3RTaGFkb3cpIGZyYW1lLnNldCgnc2hhZG93JywgbmV3IGZhYnJpYy5TaGFkb3coJ3JnYmEoMCwwLDAsMC4xKSAwcHggNHB4IDEwcHgnKSk7IGNhbnZhcy5hZGQoZnJhbWUpOyB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxheW91dC5vdmVybGF5VGV4dCkgeyBsYXlvdXQub3ZlcmxheVRleHQuZm9yRWFjaCh0ID0+IHsgY29uc3QgdHh0ID0gbmV3IGZhYnJpYy5UZXh0KHQudGV4dCwgeyBsZWZ0OiB0LnggKiBsYXlvdXQud2lkdGgsIHRvcDogdC55ICogbGF5b3V0LmhlaWdodCwgb3JpZ2luWDogJ2NlbnRlcicsIG9yaWdpblk6ICdjZW50ZXInLCBmaWxsOiB0LmNvbG9yLCBmb250RmFtaWx5OiAnU3luZScsIGZvbnRXZWlnaHQ6ICdib2xkJywgZm9udFNpemU6IDQwLCBzZWxlY3RhYmxlOiB0cnVlIH0pOyBjYW52YXMuYWRkKHR4dCk7IH0pOyB9CgogICAgICAgICAgICByZXNpemVXcmFwcGVyKCk7IHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCByZXNpemVXcmFwcGVyKTsKICAgICAgICAgICAgc2F2ZUhpc3RvcnkodHJ1ZSk7IC8vIEluaXRpYWwgc3RhdGUKICAgICAgICB9CgogICAgICAgIC8vIC0tLSBISVNUT1JZIEZVTkNUSU9OUyAtLS0KICAgICAgICBmdW5jdGlvbiBzYXZlSGlzdG9yeShmb3JjZSA9IGZhbHNlKSB7CiAgICAgICAgICAgIGlmIChoaXN0b3J5UHJvY2Vzc2luZyAmJiAhZm9yY2UpIHJldHVybjsKICAgICAgICAgICAgLy8gRGVib3VuY2Ugb3Igc2xpZ2h0IGRlbGF5IGNvdWxkIGJlIGFkZGVkIGhlcmUgZm9yIHBlcmZvcm1hbmNlIGlmIG5lZWRlZAoKICAgICAgICAgICAgLy8gUmVtb3ZlICdmdXR1cmUnIGhpc3RvcnkgaWYgd2UgYXJlIGluIHRoZSBtaWRkbGUgb2YgdGhlIHN0YWNrCiAgICAgICAgICAgIGlmIChoaXN0b3J5U3RlcCA8IGhpc3RvcnkubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgaGlzdG9yeSA9IGhpc3Rvcnkuc2xpY2UoMCwgaGlzdG9yeVN0ZXAgKyAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KGNhbnZhcy50b0pTT04oWydkYXRhJywgJ3NlbGVjdGFibGUnLCAnZXZlbnRlZCcsICdhYnNvbHV0ZVBvc2l0aW9uZWQnXSkpOwogICAgICAgICAgICBoaXN0b3J5LnB1c2goanNvbik7CiAgICAgICAgICAgIGhpc3RvcnlTdGVwKys7CiAgICAgICAgICAgIHVwZGF0ZUhpc3RvcnlCdXR0b25zKCk7CiAgICAgICAgfQoKICAgICAgICB3aW5kb3cudW5kbyA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKGhpc3RvcnlTdGVwID4gMCkgewogICAgICAgICAgICAgICAgaGlzdG9yeVByb2Nlc3NpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgaGlzdG9yeVN0ZXAtLTsKICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUKICAgICAgICAgICAgICAgIGNhbnZhcy5sb2FkRnJvbUpTT04oaGlzdG9yeVtoaXN0b3J5U3RlcF0sICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBSZS1yZW5kZXIKICAgICAgICAgICAgICAgICAgICBjYW52YXMucmVuZGVyQWxsKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gUmUtYXR0YWNoIGNsaXBzIG9yIGVuc3VyZSB0aGV5IGFyZSByZXN0b3JlZCBjb3JyZWN0bHk/IAogICAgICAgICAgICAgICAgICAgIC8vIEZhYnJpYyB0b0pTT04gcHJlc2VydmVzIGNsaXBQYXRoIHNvIGl0IHNob3VsZCBiZSBmaW5lLgogICAgICAgICAgICAgICAgICAgIGhpc3RvcnlQcm9jZXNzaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgLy8gSG9va3MgbG9zZSBjb250ZXh0PyBObywgYnV0IG9iamVjdHMgYXJlIG5ldyBpbnN0YW5jZXMuCgogICAgICAgICAgICAgICAgICAgIC8vIElNUE9SVEFOVDogUmUtYXBwbHkgYW55IGV4dGVybmFsIHN0YXRlIGlmIG5lZWRlZCAobGlrZSBCZ0NvbG9yIHRyYWNraW5nKQogICAgICAgICAgICAgICAgICAgIGlmIChjYW52YXMuYmFja2dyb3VuZENvbG9yICYmIHR5cGVvZiBjYW52YXMuYmFja2dyb3VuZENvbG9yID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50QmdDb2xvciA9IGNhbnZhcy5iYWNrZ3JvdW5kQ29sb3I7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB1cGRhdGVIaXN0b3J5QnV0dG9ucygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB3aW5kb3cucmVkbyA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKGhpc3RvcnlTdGVwIDwgaGlzdG9yeS5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICBoaXN0b3J5UHJvY2Vzc2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICBoaXN0b3J5U3RlcCsrOwogICAgICAgICAgICAgICAgY2FudmFzLmxvYWRGcm9tSlNPTihoaXN0b3J5W2hpc3RvcnlTdGVwXSwgKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNhbnZhcy5yZW5kZXJBbGwoKTsKICAgICAgICAgICAgICAgICAgICBoaXN0b3J5UHJvY2Vzc2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZUhpc3RvcnlCdXR0b25zKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhpc3RvcnlCdXR0b25zKCkgewogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndW5kby1idG4nKS5kaXNhYmxlZCA9IGhpc3RvcnlTdGVwIDw9IDA7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWRvLWJ0bicpLmRpc2FibGVkID0gaGlzdG9yeVN0ZXAgPj0gaGlzdG9yeS5sZW5ndGggLSAxOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUGFuZWwobW9kZSkgewogICAgICAgICAgICBjb25zdCBwYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYW5lbCcpOyBwYW5lbC5pbm5lckhUTUwgPSAnJzsKICAgICAgICAgICAgY29uc3QgaGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGhlYWRlci5jbGFzc05hbWUgPSAncGFuZWwtaGVhZGVyJzsgaGVhZGVyLmlubmVySFRNTCA9IGA8aDI+JHttb2RlfTwvaDI+YDsgcGFuZWwuYXBwZW5kQ2hpbGQoaGVhZGVyKTsKICAgICAgICAgICAgY29uc3QgY29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyBjb250ZW50LmNsYXNzTmFtZSA9ICdwYW5lbC1jb250ZW50JzsKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdzdGlja2VycycpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRhYnMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgdGFicy5jbGFzc05hbWUgPSAndGFicyc7CiAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhTVElDS0VSUykuZm9yRWFjaCgoY2F0LCBpKSA9PiB7IGNvbnN0IHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgdC5jbGFzc05hbWUgPSBgdGFiICR7aSA9PT0gMCA/ICdhY3RpdmUnIDogJyd9YDsgdC5pbm5lclRleHQgPSBjYXQ7IHQub25jbGljayA9ICgpID0+IHsgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRhYicpLmZvckVhY2goeCA9PiB4LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpKTsgdC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsgcmVuZGVyU3RpY2tlckdyaWQoY2F0LCBncmlkKTsgfTsgdGFicy5hcHBlbmRDaGlsZCh0KTsgfSk7IGNvbnRlbnQuYXBwZW5kQ2hpbGQodGFicyk7CiAgICAgICAgICAgICAgICBjb25zdCBncmlkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGdyaWQuY2xhc3NOYW1lID0gJ2dyaWQtNCc7IGNvbnRlbnQuYXBwZW5kQ2hpbGQoZ3JpZCk7IHJlbmRlclN0aWNrZXJHcmlkKE9iamVjdC5rZXlzKFNUSUNLRVJTKVswXSwgZ3JpZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ3RleHQnKSB7CiAgICAgICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkiIHN0eWxlPSJ3aWR0aDoxMDAlOyBqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyIiBvbmNsaWNrPSJhZGRUZXh0KCkiPisgQWRkIFRleHQ8L2J1dHRvbj48L2Rpdj48ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPkZvbnQgU3R5bGU8L2xhYmVsPjxkaXYgY2xhc3M9ImdyaWQtMiI+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgc3R5bGU9ImZvbnQtZmFtaWx5OidQbGF5ZmFpciBEaXNwbGF5JyIgb25jbGljaz0ic2V0Rm9udCgnUGxheWZhaXIgRGlzcGxheScpIj5TZXJpZjwvZGl2PjxkaXYgY2xhc3M9ImZpbHRlci1idG4iIHN0eWxlPSJmb250LWZhbWlseTonRE0gU2FucyciIG9uY2xpY2s9InNldEZvbnQoJ0RNIFNhbnMnKSI+TW9kZXJuPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgc3R5bGU9ImZvbnQtZmFtaWx5OidTeW5lJyIgb25jbGljaz0ic2V0Rm9udCgnU3luZScpIj5Cb2xkPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgc3R5bGU9ImZvbnQtZmFtaWx5OidPdXRmaXQnIiBvbmNsaWNrPSJzZXRGb250KCdPdXRmaXQnKSI+Q2xlYW48L2Rpdj48L2Rpdj48L2Rpdj48ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPkNvbG9yPC9sYWJlbD48aW5wdXQgdHlwZT0iY29sb3IiIG9uY2hhbmdlPSJzZXRDb2xvcih0aGlzLnZhbHVlKSIgdmFsdWU9IiMwMDAwMDAiPjwvZGl2PmA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2RyYXcnKSB7CiAgICAgICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPkJydXNoIFR5cGU8L2xhYmVsPjxzZWxlY3Qgb25jaGFuZ2U9InNldEJydXNoVHlwZSh0aGlzLnZhbHVlKSI+PG9wdGlvbiB2YWx1ZT0iUGVuY2lsIj5QZW5jaWw8L29wdGlvbj48b3B0aW9uIHZhbHVlPSJIaWdobGlnaHRlciI+SGlnaGxpZ2h0ZXI8L29wdGlvbj48b3B0aW9uIHZhbHVlPSJTcHJheSI+U3ByYXk8L29wdGlvbj48b3B0aW9uIHZhbHVlPSJDaXJjbGUiPkRvdHM8L29wdGlvbj48L3NlbGVjdD48L2Rpdj48ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPlNpemU8L2xhYmVsPjxpbnB1dCB0eXBlPSJyYW5nZSIgbWluPSIxIiBtYXg9IjYwIiB2YWx1ZT0iNSIgb25pbnB1dD0ic2V0QnJ1c2hTaXplKHRoaXMudmFsdWUpIj48L2Rpdj48ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPkNvbG9yPC9sYWJlbD48aW5wdXQgdHlwZT0iY29sb3IiIG9uY2hhbmdlPSJzZXRCcnVzaENvbG9yKHRoaXMudmFsdWUpIj48L2Rpdj48ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48YnV0dG9uIGNsYXNzPSJidG4gYnRuLWdob3N0IiBzdHlsZT0id2lkdGg6MTAwJSIgb25jbGljaz0idG9nZ2xlRHJhdyhmYWxzZSkiPlN0b3AgRHJhd2luZzwvYnV0dG9uPjxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgc3R5bGU9IndpZHRoOjEwMCU7IG1hcmdpbi10b3A6MTBweDsiIG9uY2xpY2s9InRvZ2dsZURyYXcodHJ1ZSkiPlN0YXJ0IERyYXdpbmc8L2J1dHRvbj48L2Rpdj5gOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdmaWx0ZXJzJykgewogICAgICAgICAgICAgICAgaWYgKGFjdGl2ZU9iamVjdCAmJiBhY3RpdmVPYmplY3QuZGF0YSAmJiBhY3RpdmVPYmplY3QuZGF0YS50eXBlID09PSAncGhvdG8nKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGVudC5pbm5lckhUTUwgPSBgPGRpdiBjbGFzcz0iY29udHJvbC1sYWJlbCI+UGhvdG8gU2hhcGU8L2Rpdj48ZGl2IGNsYXNzPSJncmlkLTMiIHN0eWxlPSJtYXJnaW4tYm90dG9tOjI0cHg7Ij48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBvbmNsaWNrPSJtYXNrUGhvdG8oJ3JlY3QnKSI+4pe8PC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ibWFza1Bob3RvKCdjaXJjbGUnKSI+4pePPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ibWFza1Bob3RvKCdoZWFydCcpIj7imaU8L2Rpdj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBvbmNsaWNrPSJtYXNrUGhvdG8oJ2Zsb3dlcicpIj7inL88L2Rpdj48ZGl2IGNsYXNzPSJmaWx0ZXItYnRuIiBvbmNsaWNrPSJtYXNrUGhvdG8oJ3N0YXInKSI+4piFPC9kaXY+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ibWFza1Bob3RvKCdjbG91ZCcpIj7imIHvuI88L2Rpdj48L2Rpdj48ZGl2IGNsYXNzPSJjb250cm9sLWxhYmVsIj5GaWx0ZXJzPC9kaXY+PGRpdiBjbGFzcz0iZ3JpZC0yIiBpZD0iZmlsdGVyLWdyaWQiPjwvZGl2PmA7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyBjb250ZW50LmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJjb250cm9sLWxhYmVsIj5GaWx0ZXJzPC9kaXY+PGRpdiBjbGFzcz0iZ3JpZC0yIiBpZD0iZmlsdGVyLWdyaWQiPjwvZGl2PmA7IH0KICAgICAgICAgICAgICAgIGNvbnN0IGZnID0gY29udGVudC5xdWVyeVNlbGVjdG9yKCcjZmlsdGVyLWdyaWQnKTsKICAgICAgICAgICAgICAgIFsnTm9uZScsICdHcmF5c2NhbGUnLCAnU2VwaWEnLCAnVmludGFnZScsICdUZWNobmljb2xvcicsICdQb2xhcm9pZCcsICdJbnZlcnQnXS5mb3JFYWNoKGYgPT4geyBjb25zdCBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGIuY2xhc3NOYW1lID0gJ2ZpbHRlci1idG4nOyBiLmlubmVyVGV4dCA9IGY7IGIub25jbGljayA9ICgpID0+IGFwcGx5RmlsdGVyKGYpOyBmZy5hcHBlbmRDaGlsZChiKTsgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2JhY2tncm91bmQnKSB7CiAgICAgICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPlNvbGlkIENvbG9yPC9sYWJlbD48aW5wdXQgdHlwZT0iY29sb3IiIG9uY2hhbmdlPSJzZXRCZ0NvbG9yKHRoaXMudmFsdWUpIiB2YWx1ZT0iJHtjdXJyZW50QmdDb2xvcn0iPjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRyb2wtZ3JvdXAiPjxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+UGF0dGVybnM8L2xhYmVsPjxkaXYgY2xhc3M9ImdyaWQtMiI+PGRpdiBjbGFzcz0iZmlsdGVyLWJ0biIgb25jbGljaz0ic2V0UGF0dGVybihudWxsKSI+Tm9uZTwvZGl2PjxkaXYgY2xhc3M9ImZpbHRlci1idG4iIG9uY2xpY2s9InNldFBhdHRlcm4oJ0RvdHMnKSI+RG90czwvZGl2PjxkaXYgY2xhc3M9ImZpbHRlci1idG4iIG9uY2xpY2s9InNldFBhdHRlcm4oJ1N0cmlwZXMnKSI+U3RyaXBlczwvZGl2PjxkaXYgY2xhc3M9ImZpbHRlci1idG4iIG9uY2xpY2s9InNldFBhdHRlcm4oJ0dyaWQnKSI+R3JpZDwvZGl2PjxkaXYgY2xhc3M9ImZpbHRlci1idG4iIG9uY2xpY2s9InNldFBhdHRlcm4oJ0NoZWNrJykiPkNoZWNrPC9kaXY+PC9kaXY+PC9kaXY+YDsKICAgICAgICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAnbWFnaWMnKSB7CiAgICAgICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJjb250cm9sLWdyb3VwIj48bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPkFJIEVmZmVjdHM8L2xhYmVsPjxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QiIHN0eWxlPSJ3aWR0aDoxMDAlOyBtYXJnaW4tYm90dG9tOjEycHgiIG9uY2xpY2s9Im1hZ2ljUmVtaXgoKSI+4pyoIEF1dG8gUmVtaXg8L2J1dHRvbj48ZGl2IGNsYXNzPSJncmlkLTIiPjxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QiIHN0eWxlPSJmb250LXNpemU6MC43NXJlbSIgb25jbGljaz0iYXBwbHlNYWdpYygnZHVvdG9uZScpIj7wn46oIER1b3RvbmU8L2J1dHRvbj48YnV0dG9uIGNsYXNzPSJidG4gYnRuLWdob3N0IiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW0iIG9uY2xpY2s9ImFwcGx5TWFnaWMoJ2N5YmVyJykiPvCfkb4gQ3liZXI8L2J1dHRvbj48YnV0dG9uIGNsYXNzPSJidG4gYnRuLWdob3N0IiBzdHlsZT0iZm9udC1zaXplOjAuNzVyZW0iIG9uY2xpY2s9ImFwcGx5TWFnaWMoJ25vc3RhbGdpYScpIj7wn5Ww77iPIE5vc3RhbGdpYTwvYnV0dG9uPjxidXR0b24gY2xhc3M9ImJ0biBidG4tZ2hvc3QiIHN0eWxlPSJmb250LXNpemU6MC43NXJlbSIgb25jbGljaz0iYWRkQ29uZmV0dGkoKSI+8J+OiSBDb25mZXR0aTwvYnV0dG9uPjwvZGl2PjwvZGl2PmA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFuZWwuYXBwZW5kQ2hpbGQoY29udGVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclN0aWNrZXJHcmlkKGNhdCwgY29udGFpbmVyKSB7IGNvbnRhaW5lci5pbm5lckhUTUwgPSAnJzsgKFNUSUNLRVJTW2NhdF0gfHwgW10pLmZvckVhY2gocyA9PiB7IGNvbnN0IGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGVsLmNsYXNzTmFtZSA9ICdpdGVtLWJveCc7IGVsLmlubmVyVGV4dCA9IHM7IGVsLm9uY2xpY2sgPSAoKSA9PiB7IGFkZFN0aWNrZXIocyk7IH07IGNvbnRhaW5lci5hcHBlbmRDaGlsZChlbCk7IH0pOyB9CiAgICAgICAgZnVuY3Rpb24gc2V0dXBUb29sYmFyKCkgewogICAgICAgICAgICBjb25zdCBidG5zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRvb2wtYnRuJyk7CiAgICAgICAgICAgIGNvbnN0IHBhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhbmVsJyk7CgogICAgICAgICAgICBidG5zLmZvckVhY2goYiA9PiB7CiAgICAgICAgICAgICAgICBiLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2FzQWN0aXZlID0gYi5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUGFuZWxPcGVuID0gcGFuZWwuY2xhc3NMaXN0LmNvbnRhaW5zKCdvcGVuJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIElmIGNsaWNraW5nIGFjdGl2ZSBidXR0b24sIHRvZ2dsZSBwYW5lbCAoY2xvc2UgaXQpCiAgICAgICAgICAgICAgICAgICAgaWYgKHdhc0FjdGl2ZSAmJiBpc1BhbmVsT3BlbikgewogICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC5jbGFzc0xpc3QucmVtb3ZlKCdvcGVuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgncGFuZWwtYWN0aXZlJyk7IC8vIFJlbW92ZSBzaGlmdAogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHJlc2l6ZVdyYXBwZXIsIDMwMCk7IC8vIFJlLWNlbnRlciBjYW52YXMKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYnRucy5mb3JFYWNoKHggPT4geC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgICAgICAgICAgICAgYi5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICByZW5kZXJQYW5lbChiLmRhdGFzZXQuaWQpOwoKICAgICAgICAgICAgICAgICAgICAvLyBPcGVuIHBhbmVsCiAgICAgICAgICAgICAgICAgICAgcGFuZWwuY2xhc3NMaXN0LmFkZCgnb3BlbicpOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgncGFuZWwtYWN0aXZlJyk7IC8vIFNoaWZ0IHN0YWdlIHVwCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChyZXNpemVXcmFwcGVyLCAzMDApOyAvLyBSZS1zY2FsZSBjYW52YXMgdG8gbmV3IGF2YWlsYWJsZSBoZWlnaHQKCiAgICAgICAgICAgICAgICAgICAgaWYgKGIuZGF0YXNldC5pZCAhPT0gJ2RyYXcnKSB0b2dnbGVEcmF3KGZhbHNlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQ2xlYW4gdXAgc3RhZ2UgY2xpY2sgKGNsb3NlIHBhbmVsKQogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhZ2UnKS5vbmNsaWNrID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIC8vIE9ubHkgY2xvc2UgaWYgY2xpY2tpbmcgc3RhZ2UgYmFja2dyb3VuZAogICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmlkID09PSAnc3RhZ2UnIHx8IGUudGFyZ2V0LmlkID09PSAnY2FudmFzLXdyYXBwZXInKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhbmVsJykuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicpOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgncGFuZWwtYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRvb2wtYnRuJykuZm9yRWFjaChiID0+IGIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJykpOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVzaXplV3JhcHBlciwgMzAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHdpbmRvdy5hZGRTdGlja2VyID0gKHMpID0+IHsgY29uc3QgdCA9IG5ldyBmYWJyaWMuVGV4dChzLCB7IGxlZnQ6IDQwMCwgdG9wOiA0MDAsIGZvbnRTaXplOiA4MCwgb3JpZ2luWDogJ2NlbnRlcicsIG9yaWdpblk6ICdjZW50ZXInIH0pOyBjYW52YXMuYWRkKHQpOyBjYW52YXMuc2V0QWN0aXZlT2JqZWN0KHQpOyB9OwogICAgICAgIHdpbmRvdy5hZGRUZXh0ID0gKCkgPT4geyBjb25zdCB0ID0gbmV3IGZhYnJpYy5JVGV4dCgiVHlwZSBIZXJlIiwgeyBsZWZ0OiA0MDAsIHRvcDogNDAwLCBmb250RmFtaWx5OiAnRE0gU2FucycsIGZvbnRTaXplOiA2MCwgZmlsbDogJyMwMDAnLCBvcmlnaW5YOiAnY2VudGVyJywgb3JpZ2luWTogJ2NlbnRlcicgfSk7IGNhbnZhcy5hZGQodCk7IGNhbnZhcy5zZXRBY3RpdmVPYmplY3QodCk7IHQuZW50ZXJFZGl0aW5nKCk7IH07CiAgICAgICAgd2luZG93LnNldEZvbnQgPSAoZikgPT4geyBjb25zdCBvID0gY2FudmFzLmdldEFjdGl2ZU9iamVjdCgpOyBpZiAobyAmJiBvLnNldCkgeyBvLnNldCgnZm9udEZhbWlseScsIGYpOyBjYW52YXMucmVxdWVzdFJlbmRlckFsbCgpOyB9IH07CiAgICAgICAgd2luZG93LnNldENvbG9yID0gKGMpID0+IHsgY29uc3QgbyA9IGNhbnZhcy5nZXRBY3RpdmVPYmplY3QoKTsgaWYgKG8gJiYgby5zZXQpIHsgby5zZXQoJ2ZpbGwnLCBjKTsgY2FudmFzLnJlcXVlc3RSZW5kZXJBbGwoKTsgfSB9OwogICAgICAgIHdpbmRvdy5zZXRCZ0NvbG9yID0gKGMpID0+IHsgY3VycmVudEJnQ29sb3IgPSBjOyBhcHBseUJhY2tncm91bmQoKTsgc2F2ZUhpc3RvcnkoKTsgfTsgLy8gTWFudWFsIFNhdmUKICAgICAgICB3aW5kb3cuc2V0UGF0dGVybiA9IChuYW1lKSA9PiB7IGN1cnJlbnRQYXR0ZXJuID0gbmFtZTsgYXBwbHlCYWNrZ3JvdW5kKCk7IHNhdmVIaXN0b3J5KCk7IH07IC8vIE1hbnVhbCBTYXZlCiAgICAgICAgZnVuY3Rpb24gYXBwbHlCYWNrZ3JvdW5kKCkgeyBpZiAoIWN1cnJlbnRQYXR0ZXJuKSB7IGNhbnZhcy5zZXRCYWNrZ3JvdW5kQ29sb3IoY3VycmVudEJnQ29sb3IsIGNhbnZhcy5yZW5kZXJBbGwuYmluZChjYW52YXMpKTsgfSBlbHNlIHsgY29uc3QgcGF0dGVybkRlZiA9IFBBVFRFUk5TLmZpbmQocCA9PiBwLm5hbWUgPT09IGN1cnJlbnRQYXR0ZXJuKTsgaWYgKHBhdHRlcm5EZWYpIHsgY29uc3QgcENhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOyBwQ2FudmFzLndpZHRoID0gMjA7IHBDYW52YXMuaGVpZ2h0ID0gMjA7IGNvbnN0IHBDdHggPSBwQ2FudmFzLmdldENvbnRleHQoJzJkJyk7IHBDdHguZmlsbFN0eWxlID0gY3VycmVudEJnQ29sb3I7IHBDdHguZmlsbFJlY3QoMCwgMCwgMjAsIDIwKTsgcGF0dGVybkRlZi5kcmF3KHBDdHgsIDIwLCAyMCk7IGNhbnZhcy5zZXRCYWNrZ3JvdW5kQ29sb3IobmV3IGZhYnJpYy5QYXR0ZXJuKHsgc291cmNlOiBwQ2FudmFzLCByZXBlYXQ6ICdyZXBlYXQnIH0pLCBjYW52YXMucmVuZGVyQWxsLmJpbmQoY2FudmFzKSk7IH0gfSB9CgogICAgICAgIHdpbmRvdy50b2dnbGVEcmF3ID0gKGVuYWJsZSkgPT4geyBjYW52YXMuaXNEcmF3aW5nTW9kZSA9IGVuYWJsZTsgaWYgKGVuYWJsZSkgeyBpZiAoIWNhbnZhcy5mcmVlRHJhd2luZ0JydXNoKSBjYW52YXMuZnJlZURyYXdpbmdCcnVzaCA9IG5ldyBmYWJyaWMuUGVuY2lsQnJ1c2goY2FudmFzKTsgY2FudmFzLmZyZWVEcmF3aW5nQnJ1c2gud2lkdGggPSAxMDsgY2FudmFzLmZyZWVEcmF3aW5nQnJ1c2guY29sb3IgPSAiIzAwMCI7IH0gfTsKICAgICAgICB3aW5kb3cuc2V0QnJ1c2hUeXBlID0gKHR5cGUpID0+IHsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdQZW5jaWwnKSBjYW52YXMuZnJlZURyYXdpbmdCcnVzaCA9IG5ldyBmYWJyaWMuUGVuY2lsQnJ1c2goY2FudmFzKTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdDaXJjbGUnKSBjYW52YXMuZnJlZURyYXdpbmdCcnVzaCA9IG5ldyBmYWJyaWMuQ2lyY2xlQnJ1c2goY2FudmFzKTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdTcHJheScpIGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoID0gbmV3IGZhYnJpYy5TcHJheUJydXNoKGNhbnZhcyk7CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnSGlnaGxpZ2h0ZXInKSB7CiAgICAgICAgICAgICAgICBjYW52YXMuZnJlZURyYXdpbmdCcnVzaCA9IG5ldyBmYWJyaWMuUGVuY2lsQnJ1c2goY2FudmFzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBjb2xvciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W3R5cGU9ImNvbG9yIl0nKT8udmFsdWUgfHwgIiMwMDAiOwogICAgICAgICAgICBjYW52YXMuZnJlZURyYXdpbmdCcnVzaC5jb2xvciA9IHR5cGUgPT09ICdIaWdobGlnaHRlcicgPyBjb2xvciArICc1NScgOiBjb2xvcjsKICAgICAgICAgICAgY2FudmFzLmZyZWVEcmF3aW5nQnJ1c2gud2lkdGggPSB0eXBlID09PSAnSGlnaGxpZ2h0ZXInID8gMzAgOiAxMDsKICAgICAgICB9OwogICAgICAgIHdpbmRvdy5zZXRCcnVzaFNpemUgPSAodikgPT4geyBpZiAoY2FudmFzLmZyZWVEcmF3aW5nQnJ1c2gpIGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoLndpZHRoID0gcGFyc2VJbnQodiwgMTApOyB9OwogICAgICAgIHdpbmRvdy5zZXRCcnVzaENvbG9yID0gKGMpID0+IHsgaWYgKGNhbnZhcy5mcmVlRHJhd2luZ0JydXNoKSBjYW52YXMuZnJlZURyYXdpbmdCcnVzaC5jb2xvciA9IGM7IH07CgogICAgICAgIC8vIEZJWDogTWFza2luZyBMb2dpYyAoQWJzb2x1dGUgUG9zaXRpb25pbmcpCiAgICAgICAgd2luZG93Lm1hc2tQaG90byA9IChzaGFwZSkgPT4gewogICAgICAgICAgICBjb25zdCBvYmogPSBjYW52YXMuZ2V0QWN0aXZlT2JqZWN0KCk7CiAgICAgICAgICAgIGlmICghb2JqIHx8IG9iai5kYXRhLnR5cGUgIT09ICdwaG90bycpIHJldHVybjsKICAgICAgICAgICAgY29uc3Qgc2xvdCA9IG9iai5kYXRhLnNsb3RSZWN0OwogICAgICAgICAgICBjb25zdCBjeCA9IHNsb3QubGVmdCArIHNsb3Qud2lkdGggLyAyOwogICAgICAgICAgICBjb25zdCBjeSA9IHNsb3QudG9wICsgc2xvdC5oZWlnaHQgLyAyOwogICAgICAgICAgICBjb25zdCBzaXplID0gTWF0aC5taW4oc2xvdC53aWR0aCwgc2xvdC5oZWlnaHQpOwoKICAgICAgICAgICAgbGV0IGNsaXBQYXRoOwogICAgICAgICAgICBpZiAoc2hhcGUgPT09ICdyZWN0JykgY2xpcFBhdGggPSBuZXcgZmFicmljLlJlY3QoeyBsZWZ0OiBzbG90LmxlZnQsIHRvcDogc2xvdC50b3AsIHdpZHRoOiBzbG90LndpZHRoLCBoZWlnaHQ6IHNsb3QuaGVpZ2h0LCBhYnNvbHV0ZVBvc2l0aW9uZWQ6IHRydWUgfSk7CiAgICAgICAgICAgIGVsc2UgaWYgKHNoYXBlID09PSAnY2lyY2xlJykgY2xpcFBhdGggPSBuZXcgZmFicmljLkNpcmNsZSh7IHJhZGl1czogc2l6ZSAvIDIsIGxlZnQ6IGN4LCB0b3A6IGN5LCBvcmlnaW5YOiAnY2VudGVyJywgb3JpZ2luWTogJ2NlbnRlcicsIGFic29sdXRlUG9zaXRpb25lZDogdHJ1ZSB9KTsKICAgICAgICAgICAgZWxzZSBpZiAoc2hhcGUgPT09ICdoZWFydCcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBhdGggPSAiTSAwIC0zMCBDIC0yMCAtNTAgLTUwIC0zMCAtMzAgMCBMIDAgMzAgTCAzMCAwIEMgNTAgLTMwIDIwIC01MCAwIC0zMCBaIjsKICAgICAgICAgICAgICAgIGNsaXBQYXRoID0gbmV3IGZhYnJpYy5QYXRoKHBhdGgsIHsgc2NhbGVYOiBzaXplIC8gNzAsIHNjYWxlWTogc2l6ZSAvIDcwLCBsZWZ0OiBjeCwgdG9wOiBjeSwgb3JpZ2luWDogJ2NlbnRlcicsIG9yaWdpblk6ICdjZW50ZXInLCBhYnNvbHV0ZVBvc2l0aW9uZWQ6IHRydWUgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoc2hhcGUgPT09ICdzdGFyJykgewogICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9ICJNIDAgLTUwIEwgMTIgLTE1IEwgNDggLTE1IEwgMTggOCBMIDI5IDQyIEwgMCAyNSBMIC0yOSA0MiBMIC0xOCA4IEwgLTQ4IC0xNSBMIC0xMiAtMTUgWiI7CiAgICAgICAgICAgICAgICBjbGlwUGF0aCA9IG5ldyBmYWJyaWMuUGF0aChwYXRoLCB7IHNjYWxlWDogc2l6ZSAvIDEwMCwgc2NhbGVZOiBzaXplIC8gMTAwLCBsZWZ0OiBjeCwgdG9wOiBjeSwgb3JpZ2luWDogJ2NlbnRlcicsIG9yaWdpblk6ICdjZW50ZXInLCBhYnNvbHV0ZVBvc2l0aW9uZWQ6IHRydWUgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoc2hhcGUgPT09ICdmbG93ZXInKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwYXRoID0gIk0gMCAwIEMgMCAtMTAgLTEwIC0yMCAwIC0zMCBDIDEwIC00MCAyMCAtMzAgMzAgLTQwIEMgNDAgLTMwIDMwIC0yMCA0MCAtMTAgQyA1MCAwIDQwIDEwIDMwIDIwIEMgNDAgMzAgMzAgNDAgMjAgMzAgQyAxMCA0MCAwIDMwIC0xMCA0MCBDIC0yMCAzMCAtMzAgNDAgLTQwIDMwIEMgLTUwIDQwIC00MCAyMCAtNTAgMTAgQyAtNDAgMCAtNTAgLTEwIC00MCAtMjAgQyAtMzAgLTMwIC0yMCAtMjAgLTEwIC0zMCBaIjsKICAgICAgICAgICAgICAgIGNsaXBQYXRoID0gbmV3IGZhYnJpYy5QYXRoKHBhdGgsIHsgc2NhbGVYOiBzaXplIC8gMTAwLCBzY2FsZVk6IHNpemUgLyAxMDAsIGxlZnQ6IGN4LCB0b3A6IGN5LCBvcmlnaW5YOiAnY2VudGVyJywgb3JpZ2luWTogJ2NlbnRlcicsIGFic29sdXRlUG9zaXRpb25lZDogdHJ1ZSB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChzaGFwZSA9PT0gJ2Nsb3VkJykgewogICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9ICJNIDI1LDYwIGEgMjAsMjAgMCAwLDEgMCwtNDAgYSAyMCwyMCAwIDAsMSA0MCwtMTAgYSAyMCwyMCAwIDAsMSA0MCwxMCBhIDIwLDIwIDAgMCwxIDAsNDAgeiI7CiAgICAgICAgICAgICAgICBjbGlwUGF0aCA9IG5ldyBmYWJyaWMuUGF0aChwYXRoLCB7IHNjYWxlWDogc2l6ZSAvIDEyMCwgc2NhbGVZOiBzaXplIC8gMTAwLCBsZWZ0OiBjeCwgdG9wOiBjeSwgb3JpZ2luWDogJ2NlbnRlcicsIG9yaWdpblk6ICdjZW50ZXInLCBhYnNvbHV0ZVBvc2l0aW9uZWQ6IHRydWUgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjbGlwUGF0aCkgewogICAgICAgICAgICAgICAgb2JqLmNsaXBQYXRoID0gY2xpcFBhdGg7CiAgICAgICAgICAgICAgICBvYmouZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgY2FudmFzLnJlcXVlc3RSZW5kZXJBbGwoKTsKICAgICAgICAgICAgICAgIHNhdmVIaXN0b3J5KCk7IC8vIEF1dG8gU2F2ZQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cucHJpbnRQaG90byA9ICgpID0+IHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNhbnZhcy5kaXNjYXJkQWN0aXZlT2JqZWN0KCk7CiAgICAgICAgICAgICAgICBjYW52YXMucmVuZGVyQWxsKCk7CgogICAgICAgICAgICAgICAgY29uc3QgZGF0YVVSTCA9IGNhbnZhcy50b0RhdGFVUkwoewogICAgICAgICAgICAgICAgICAgIGZvcm1hdDogJ3BuZycsCiAgICAgICAgICAgICAgICAgICAgcXVhbGl0eTogMSwKICAgICAgICAgICAgICAgICAgICBtdWx0aXBsaWVyOiAyCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBwYXJlbnQucG9zdE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJQUklOVF9TVFJJUCIsCiAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IGRhdGFVUkwKICAgICAgICAgICAgICAgIH0sIHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4pOwoKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgYWxlcnQoIlByaW50IGZhaWxlZDogIiArIGUubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCgogICAgICAgIHdpbmRvdy5hcHBseUZpbHRlciA9IChuYW1lKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IG9iaiA9IGNhbnZhcy5nZXRBY3RpdmVPYmplY3QoKTsgaWYgKCFvYmogfHwgIW9iai5maWx0ZXJzKSByZXR1cm47IG9iai5maWx0ZXJzID0gW107CiAgICAgICAgICAgIGlmIChuYW1lICE9PSAnTm9uZScpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGZNYXAgPSB7ICdHcmF5c2NhbGUnOiBuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuR3JheXNjYWxlKCksICdTZXBpYSc6IG5ldyBmYWJyaWMuSW1hZ2UuZmlsdGVycy5TZXBpYSgpLCAnSW52ZXJ0JzogbmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLkludmVydCgpLCAnVmludGFnZSc6IG5ldyBmYWJyaWMuSW1hZ2UuZmlsdGVycy5Ob2lzZSh7IG5vaXNlOiA1MCB9KSwgJ1RlY2huaWNvbG9yJzogbmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLlRlY2huaWNvbG9yKCksICdQb2xhcm9pZCc6IG5ldyBmYWJyaWMuSW1hZ2UuZmlsdGVycy5Qb2xhcm9pZCgpIH07CiAgICAgICAgICAgICAgICBpZiAoZk1hcFtuYW1lXSkgb2JqLmZpbHRlcnMucHVzaChmTWFwW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvYmouYXBwbHlGaWx0ZXJzKCk7IGNhbnZhcy5yZXF1ZXN0UmVuZGVyQWxsKCk7CiAgICAgICAgICAgIHNhdmVIaXN0b3J5KCk7IC8vIEF1dG8gU2F2ZQogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5tYWdpY1JlbWl4ID0gKCkgPT4gewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcyA9IFNUSUNLRVJTWydWaWJlcyddW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIFNUSUNLRVJTWydWaWJlcyddLmxlbmd0aCldOwogICAgICAgICAgICAgICAgY29uc3QgdCA9IG5ldyBmYWJyaWMuVGV4dChzLCB7IGxlZnQ6IE1hdGgucmFuZG9tKCkgKiBjYW52YXMud2lkdGgsIHRvcDogTWF0aC5yYW5kb20oKSAqIGNhbnZhcy5oZWlnaHQsIGZvbnRTaXplOiA2MCB9KTsKICAgICAgICAgICAgICAgIGNhbnZhcy5hZGQodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2F2ZUhpc3RvcnkoKTsgLy8gQXV0byBTYXZlCiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuYWRkQ29uZmV0dGkgPSAoKSA9PiB7IGZvciAobGV0IGkgPSAwOyBpIDwgMjA7IGkrKykgeyBjb25zdCBjb2xvciA9IGBoc2woJHtNYXRoLnJhbmRvbSgpICogMzYwfSwgMTAwJSwgNTAlKWA7IGNvbnN0IHNoYXBlID0gTWF0aC5yYW5kb20oKSA+IDAuNSA/IG5ldyBmYWJyaWMuQ2lyY2xlKHsgcmFkaXVzOiBNYXRoLnJhbmRvbSgpICogMTAgKyA1LCBmaWxsOiBjb2xvciwgbGVmdDogTWF0aC5yYW5kb20oKSAqIGNhbnZhcy53aWR0aCwgdG9wOiBNYXRoLnJhbmRvbSgpICogY2FudmFzLmhlaWdodCB9KSA6IG5ldyBmYWJyaWMuUmVjdCh7IHdpZHRoOiBNYXRoLnJhbmRvbSgpICogMjAgKyAxMCwgaGVpZ2h0OiBNYXRoLnJhbmRvbSgpICogMjAgKyAxMCwgZmlsbDogY29sb3IsIGxlZnQ6IE1hdGgucmFuZG9tKCkgKiBjYW52YXMud2lkdGgsIHRvcDogTWF0aC5yYW5kb20oKSAqIGNhbnZhcy5oZWlnaHQsIGFuZ2xlOiBNYXRoLnJhbmRvbSgpICogMzYwIH0pOyBjYW52YXMuYWRkKHNoYXBlKTsgfSBjYW52YXMucmVxdWVzdFJlbmRlckFsbCgpOyBzYXZlSGlzdG9yeSgpOyB9OwoKICAgICAgICB3aW5kb3cuYXBwbHlNYWdpYyA9ICh0eXBlKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IG9iaiA9IGNhbnZhcy5nZXRBY3RpdmVPYmplY3QoKTsKICAgICAgICAgICAgaWYgKCFvYmogfHwgIW9iai5maWx0ZXJzKSByZXR1cm47CiAgICAgICAgICAgIG9iai5maWx0ZXJzID0gW107CiAgICAgICAgICAgIGlmICh0eXBlID09PSAnZHVvdG9uZScpIHsKICAgICAgICAgICAgICAgIG9iai5maWx0ZXJzLnB1c2gobmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLkdyYXlzY2FsZSgpKTsKICAgICAgICAgICAgICAgIG9iai5maWx0ZXJzLnB1c2gobmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLkJsZW5kQ29sb3IoeyBjb2xvcjogJyNGRjAwRkYnLCBtb2RlOiAnc2NyZWVuJyB9KSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2N5YmVyJykgewogICAgICAgICAgICAgICAgb2JqLmZpbHRlcnMucHVzaChuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuQ29udHJhc3QoeyBjb250cmFzdDogMC4zIH0pKTsKICAgICAgICAgICAgICAgIG9iai5maWx0ZXJzLnB1c2gobmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLlNhdHVyYXRpb24oeyBzYXR1cmF0aW9uOiAwLjUgfSkpOwogICAgICAgICAgICAgICAgLy8gR3JlZW4gVGludAogICAgICAgICAgICAgICAgb2JqLmZpbHRlcnMucHVzaChuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuQmxlbmRDb2xvcih7IGNvbG9yOiAnIzAwRkYwMCcsIG1vZGU6ICdvdmVybGF5JywgYWxwaGE6IDAuMiB9KSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ25vc3RhbGdpYScpIHsKICAgICAgICAgICAgICAgIG9iai5maWx0ZXJzLnB1c2gobmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLlNlcGlhKCkpOwogICAgICAgICAgICAgICAgb2JqLmZpbHRlcnMucHVzaChuZXcgZmFicmljLkltYWdlLmZpbHRlcnMuTm9pc2UoeyBub2lzZTogMTAwIH0pKTsKICAgICAgICAgICAgICAgIG9iai5maWx0ZXJzLnB1c2gobmV3IGZhYnJpYy5JbWFnZS5maWx0ZXJzLkNvbnRyYXN0KHsgY29udHJhc3Q6IC0wLjEgfSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9iai5hcHBseUZpbHRlcnMoKTsKICAgICAgICAgICAgY2FudmFzLnJlcXVlc3RSZW5kZXJBbGwoKTsKICAgICAgICAgICAgc2F2ZUhpc3RvcnkoKTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cudXBkYXRlU2VsZWN0aW9uID0gKG9iaikgPT4gewogICAgICAgICAgICBhY3RpdmVPYmplY3QgPSBvYmo7CiAgICAgICAgICAgIGNvbnN0IGFjdGl2ZVRvb2wgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudG9vbC1idG4uYWN0aXZlJyk7CiAgICAgICAgICAgIGlmIChhY3RpdmVUb29sKSByZW5kZXJQYW5lbChhY3RpdmVUb29sLmRhdGFzZXQuaWQpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcmVzaXplV3JhcHBlcigpIHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGFnZScpOwogICAgICAgICAgICBjb25zdCB3ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NhbnZhcy13cmFwcGVyJyk7CiAgICAgICAgICAgIGlmICghYyB8fCAhdyB8fCAhY2FudmFzKSByZXR1cm47CgogICAgICAgICAgICBjb25zdCBjdyA9IGNhbnZhcy5nZXRXaWR0aCgpOwogICAgICAgICAgICBjb25zdCBjaCA9IGNhbnZhcy5nZXRIZWlnaHQoKTsKICAgICAgICAgICAgdy5zdHlsZS53aWR0aCA9IGN3ICsgJ3B4JzsKICAgICAgICAgICAgdy5zdHlsZS5oZWlnaHQgPSBjaCArICdweCc7CgogICAgICAgICAgICBsZXQgYXZhaWxhYmxlSCA9IGMuY2xpZW50SGVpZ2h0IC0gNDA7CiAgICAgICAgICAgIC8vIFN1YnRyYWN0IHBhbmVsIGhlaWdodCBpZiBvcGVuCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5jb250YWlucygncGFuZWwtYWN0aXZlJykpIHsKICAgICAgICAgICAgICAgIGF2YWlsYWJsZUggLT0gMzQwOyAvLyBBcHByb3ggaGVpZ2h0IG9mIHByb3BlcnRpZXMgcGFuZWwKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQWxsb3cgbW9yZSB3aWR0aCB1c2FnZSBvbiBtb2JpbGUKICAgICAgICAgICAgY29uc3QgYXZhaWxhYmxlVyA9IGMuY2xpZW50V2lkdGggLSAod2luZG93LmlubmVyV2lkdGggPCA2MDAgPyAxMCA6IDQwKTsKCiAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gTWF0aC5taW4oYXZhaWxhYmxlVyAvIGN3LCBhdmFpbGFibGVIIC8gY2gpOwoKICAgICAgICAgICAgdy5zdHlsZS50cmFuc2Zvcm0gPSBgc2NhbGUoJHtNYXRoLm1heCgwLjEsIHNjYWxlKX0pYDsgLy8gUHJldmVudCBpbnZhbGlkIHNjYWxlCgogICAgICAgICAgICAvLyBBZGp1c3QgdHJhbnNmb3JtIG9yaWdpbiBmb3Igc21vb3RoZXIgVVgKICAgICAgICAgICAgdy5zdHlsZS50cmFuc2Zvcm1PcmlnaW4gPSBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5jb250YWlucygncGFuZWwtYWN0aXZlJykgPyAnY2VudGVyIHRvcCcgOiAnY2VudGVyIGNlbnRlcic7CiAgICAgICAgICAgIHcuc3R5bGUubWFyZ2luVG9wID0gZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuY29udGFpbnMoJ3BhbmVsLWFjdGl2ZScpID8gJzIwcHgnIDogJzAnOwogICAgICAgIH0KICAgICAgICAvLyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2F2ZS1idG4nKS5vbmNsaWNrID0gLi4uIChMZWdhY3kgcmVtb3ZlZCkKCiAgICA8L3NjcmlwdD4KCg==";
            var d = atob(e); // Decode
            // Safe injection:
            document.body.innerHTML = d;
            
            // Restore visibility
            document.body.style.visibility = 'visible'; 
            document.body.style.opacity = '1';
            
            // Re-run scripts in the injected content? 
            // innerHTML does NOT execute <script> tags automatically.
            // We need to manually execute them.
            
            var scripts = document.body.getElementsByTagName("script");
            for (var i = 0; i < scripts.length; i++) {
                var oldScript = scripts[i];
                var newScript = document.createElement("script");
                newScript.text = oldScript.text;
                if (oldScript.src) newScript.src = oldScript.src;
                if (oldScript.type) newScript.type = oldScript.type;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            }
            
            console.log("Secure Content Loaded");
        })();
    </script>
</body>
</html>